<template>
    <div class="qfr-form-container">
        <!-- Progress Indicator -->
        <lightning-progress-indicator 
            current-step={currentStep} 
            type="path" 
            variant="base">
            <lightning-progress-step 
                label="Residential Viability" 
                value="1">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Contact Information" 
                value="2">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Business Structure" 
                value="3">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Labour Costs" 
                value="4">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Document Upload" 
                value="5">
            </lightning-progress-step>
        </lightning-progress-indicator>

        <!-- Page 1: Residential Viability and Prudential Reporting -->
        <div if:true={isPage1} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Residential Viability and Prudential Reporting</h2>
            </div>

            <!-- Information Section -->
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}>
                <lightning-accordion-section name="about-section" label="About this section">
                    <div class="slds-p-around_medium">
                        <p class="slds-text-body_regular">
                            This section collects information about the financial health and viability of residential care services 
                            to identify providers who may need additional support or intervention. Your responses help us understand 
                            your organization's current financial position and forecast any potential concerns.
                        </p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <!-- Solvency Assessment -->
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Solvency Assessment</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label slds-text-body_regular">
                            Are you currently concerned about the solvency of your organisation?
                        </label>
                        <lightning-radio-group 
                            name="solvencyConcern"
                            options={yesNoOptions}
                            value={formData.solvencyConcern}
                            type="button"
                            onchange={handleInputChange}>
                        </lightning-radio-group>
                        <div if:true={errors.solvencyConcern} class="slds-form-element__help error-message">
                            {errors.solvencyConcern}
                        </div>
                    </div>

                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label slds-text-body_regular">
                            Do you envisage any solvency issues arising in the next six months?
                        </label>
                        <lightning-radio-group 
                            name="futureSolvencyIssues"
                            options={yesNoOptions}
                            value={formData.futureSolvencyIssues}
                            type="button"
                            onchange={handleInputChange}>
                        </lightning-radio-group>
                        <div if:true={errors.futureSolvencyIssues} class="slds-form-element__help error-message">
                            {errors.futureSolvencyIssues}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Performance Assessment -->
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Financial Performance Assessment</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-form-element">
                        <label class="slds-form-element__label slds-text-body_regular">
                            Do you forecast an operational loss for the current year?
                            <lightning-helptext 
                                content="An operational loss occurs when operating expenses exceed operating revenues from your core care services. Consider your year-to-date performance, budget forecasts, and any extraordinary items that may impact this year's results. This excludes investment income or one-time asset sales.">
                            </lightning-helptext>
                        </label>
                        <lightning-radio-group 
                            name="operationalLoss"
                            options={yesNoOptions}
                            value={formData.operationalLoss}
                            type="button"
                            onchange={handleInputChange}>
                        </lightning-radio-group>
                        <div if:true={errors.operationalLoss} class="slds-form-element__help error-message">
                            {errors.operationalLoss}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Provider Contact Information -->
        <div if:true={isPage2} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Provider Contact Information</h2>
            </div>

            <!-- Account Information -->
            <div class="slds-card slds-m-bottom_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Account Information</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-grid slds-wrap">
                        <div class="slds-col slds-size_1-of-2 slds-p-right_small">
                            <lightning-formatted-text 
                                value={accountInfo.organizationName}
                                class="slds-text-body_regular">
                            </lightning-formatted-text>
                            <p class="slds-text-color_weak">Organization Name</p>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                            <lightning-formatted-text 
                                value={accountInfo.napsId}
                                class="slds-text-body_regular">
                            </lightning-formatted-text>
                            <p class="slds-text-color_weak">NAPS ID</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Primary Contact Information -->
            <div class="slds-card">
                <div class="slds-card__header slds-grid">
                    <h3 class="slds-card__header-title slds-text-heading_small slds-grow">Primary Contact</h3>
                    <lightning-button 
                        label={editButtonLabel}
                        variant={editButtonVariant}
                        onclick={handleEditContact}>
                    </lightning-button>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div if:false={isEditingContact} class="contact-display">
                        <div class="slds-grid slds-wrap">
                            <div class="slds-col slds-size_1-of-2 slds-p-right_small slds-m-bottom_small">
                                <lightning-formatted-text 
                                    value={formData.contactName}
                                    class="slds-text-body_regular">
                                </lightning-formatted-text>
                                <p class="slds-text-color_weak">Name</p>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-p-left_small slds-m-bottom_small">
                                <lightning-formatted-text 
                                    value={formData.contactPosition}
                                    class="slds-text-body_regular">
                                </lightning-formatted-text>
                                <p class="slds-text-color_weak">Position</p>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-p-right_small">
                                <lightning-formatted-phone 
                                    value={formData.contactPhone}
                                    class="slds-text-body_regular">
                                </lightning-formatted-phone>
                                <p class="slds-text-color_weak">Phone</p>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                                <lightning-formatted-email 
                                    value={formData.contactEmail}
                                    class="slds-text-body_regular">
                                </lightning-formatted-email>
                                <p class="slds-text-color_weak">Email</p>
                            </div>
                        </div>
                    </div>

                    <div if:true={isEditingContact} class="contact-edit">
                        <div class="slds-grid slds-wrap">
                            <div class="slds-col slds-size_1-of-2 slds-p-right_small">
                                <lightning-input 
                                    label="Name"
                                    name="contactName"
                                    value={formData.contactName}
                                    onchange={handleInputChange}
                                    required>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                                <lightning-input 
                                    label="Position"
                                    name="contactPosition"
                                    value={formData.contactPosition}
                                    onchange={handleInputChange}
                                    required>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-p-right_small">
                                <lightning-input 
                                    label="Phone"
                                    name="contactPhone"
                                    type="tel"
                                    value={formData.contactPhone}
                                    onchange={handleInputChange}
                                    required>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                                <lightning-input 
                                    label="Email"
                                    name="contactEmail"
                                    type="email"
                                    value={formData.contactEmail}
                                    onchange={handleInputChange}
                                    required>
                                </lightning-input>
                            </div>
                        </div>
                        <div class="slds-m-top_medium">
                            <lightning-button 
                                label="Save"
                                variant="brand"
                                onclick={handleSaveContact}
                                class="slds-m-right_small">
                            </lightning-button>
                            <lightning-button 
                                label="Cancel"
                                variant="neutral"
                                onclick={handleCancelEdit}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Business Structure Configuration -->
        <div if:true={isPage3} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Business Structure Configuration</h2>
            </div>

            <!-- Business Structure Selection -->
            <div class="slds-card slds-m-bottom_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Business Structure Types</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <template for:each={businessStructureTypes} for:item="structureType">
                        <div key={structureType.name} class="structure-type-section slds-m-bottom_large">
                            <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                <h4 class="slds-text-heading_small">{structureType.label}</h4>
                                <lightning-input 
                                    type="toggle"
                                    name={structureType.name}
                                    checked={structureType.selected}
                                    onchange={handleStructureToggle}
                                    data-structure={structureType.name}>
                                </lightning-input>
                            </div>
                            
                            <div if:true={structureType.selected} class="structure-details slds-p-left_medium">
                                <div class="slds-form-element slds-m-bottom_medium">
                                    <label class="slds-form-element__label">Service Types</label>
                                    <lightning-checkbox-group 
                                        name={structureType.serviceTypesName}
                                        options={serviceTypeOptions}
                                        value={structureType.serviceTypes}
                                        onchange={handleServiceTypeChange}>
                                    </lightning-checkbox-group>
                                </div>
                                
                                <lightning-textarea 
                                    label="Additional Information (Optional)"
                                    name={structureType.additionalInfoName}
                                    value={structureType.additionalInfo}
                                    onchange={handleAdditionalInfoChange}
                                    placeholder="Please provide percentage breakdowns and explanations">
                                </lightning-textarea>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Workforce Configuration -->
            <div class="slds-card">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Workforce Configuration</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <lightning-combobox 
                        label="How are your direct care workers engaged?"
                        name="workforceEngagement"
                        value={formData.workforceEngagement}
                        options={workforceOptions}
                        onchange={handleInputChange}
                        required>
                    </lightning-combobox>
                </div>
            </div>
        </div>

        <!-- Page 4: Labour Costs Data Management -->
        <div if:true={isPage4} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Labour Costs Data Management</h2>
            </div>

            <!-- Table Controls -->
            <div class="slds-card">
                <div class="slds-card__header">
                    <div class="slds-grid slds-grid_align-spread">
                        <h3 class="slds-card__header-title slds-text-heading_small">Internal Direct Care Labour Costs</h3>
                        <div class="table-controls slds-grid slds-grid_align-end">
                            <lightning-combobox 
                                label="View All"
                                name="tableFilter"
                                value={tableFilter}
                                options={tableFilterOptions}
                                onchange={handleTableFilteronchange={handleTableFilter}
                                class="slds-m-right_small">
                            </lightning-combobox>
                            <lightning-combobox 
                                label="Jump to Section"
                                name="jumpToSection"
                                value={jumpToSection}
                                options={sectionOptions}
                                onchange={handleJumpToSection}
                                class="slds-m-right_small">
                            </lightning-combobox>
                            <lightning-combobox 
                                label="Jump to Column"
                                name="jumpToColumn"
                                value={jumpToColumn}
                                options={columnOptions}
                                onchange={handleJumpToColumn}>
                            </lightning-combobox>
                        </div>
                    </div>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-form-element slds-m-bottom_medium">
                        <lightning-input 
                            type="toggle"
                            label="Centrally Held"
                            name="centrallyHeld"
                            checked={formData.centrallyHeld}
                            onchange={handleInputChange}>
                        </lightning-input>
                    </div>

                    <lightning-datatable 
                        key-field="id"
                        data={filteredLabourData}
                        columns={labourCostColumns}
                        oncellchange={handleCellChange}
                        hide-checkbox-column="true">
                    </lightning-datatable>
                </div>
            </div>
        </div>

        <!-- Page 5: Document Management and Submission -->
        <div if:true={isPage5} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Document Management and Submission</h2>
            </div>

            <!-- Document Upload -->
            <div class="slds-card slds-m-bottom_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Document Upload</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-grid slds-wrap slds-m-bottom_medium">
                        <div class="slds-col slds-size_1-of-2 slds-p-right_small">
                            <lightning-combobox 
                                label="Document Category"
                                name="documentCategory"
                                value={documentCategory}
                                options={documentCategoryOptions}
                                onchange={handleDocumentCategoryChange}
                                required>
                            </lightning-combobox>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                            <lightning-combobox 
                                label="Document Type"
                                name="documentType"
                                value={documentType}
                                options={documentTypeOptions}
                                onchange={handleDocumentTypeChange}
                                required>
                            </lightning-combobox>
                        </div>
                    </div>

                    <div class="file-upload-area" ondrop={handleFileDrop} ondragover={handleDragOver}>
                        <div class="slds-text-align_center slds-p-around_large">
                            <lightning-icon icon-name="utility:upload" size="large" class="slds-m-bottom_small"></lightning-icon>
                            <p class="slds-text-heading_small slds-m-bottom_small">Drag and drop files here</p>
                            <p class="slds-text-body_regular slds-m-bottom_medium">or</p>
                            <lightning-button 
                                label="Browse Files"
                                variant="neutral"
                                onclick={handleBrowseFiles}>
                            </lightning-button>
                            <input type="file" class="file-input" onchange={handleFileSelect} multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
                        </div>
                    </div>

                    <div if:true={isUploading} class="slds-m-top_medium">
                        <lightning-spinner alternative-text="Uploading files..." size="small"></lightning-spinner>
                        <p class="slds-text-body_small slds-m-top_small">Uploading files...</p>
                    </div>
                </div>
            </div>

            <!-- Document Management Table -->
            <div class="slds-card" if:true={hasUploadedFiles}>
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Uploaded Documents</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <lightning-datatable 
                        key-field="id"
                        data={uploadedFiles}
                        columns={documentColumns}
                        onrowaction={handleDocumentAction}
                        hide-checkbox-column="true">
                    </lightning-datatable>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons slds-m-top_large">
            <lightning-button 
                label="Previous"
                variant="neutral"
                onclick={handlePrevious}
                disabled={isPreviousDisabled}
                class="slds-float_left">
            </lightning-button>
            
            <lightning-button 
                label={nextButtonLabel}
                variant="brand"
                onclick={handleNext}
                disabled={isNextDisabled}
                class="slds-float_right">
            </lightning-button>
        </div>

        <!-- Loading Spinner -->
        <div if:true={isLoading} class="loading-overlay">
            <lightning-spinner alternative-text="Processing..." size="large"></lightning-spinner>
        </div>
    </div>
</template>
