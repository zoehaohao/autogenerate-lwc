<template>
    <div class="qfr-form-container">
        <!-- Progress Indicator -->
        <lightning-progress-indicator 
            current-step={currentStep} 
            type="path" 
            variant="base">
            <lightning-progress-step 
                label="Residential Viability" 
                value="1">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Contact Information" 
                value="2">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Business Structure" 
                value="3">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Labour Costs" 
                value="4">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Document Management" 
                value="5">
            </lightning-progress-step>
        </lightning-progress-indicator>

        <!-- Page 1: Residential Viability and Prudential Reporting -->
        <div if:true={isPage1} class="page-container">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Residential Viability and Prudential Reporting</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Information Section -->
                    <lightning-accordion 
                        active-section-name={openSections} 
                        allow-multiple-sections-open="true"
                        onselect={handleAccordionToggle}>
                        <lightning-accordion-section name="about-section" label="About this section">
                            <div class="slds-p-around_medium">
                                <p>This section collects information about the financial health and viability of residential care services to identify providers who may need additional support or intervention. Your responses help us understand your organization's current financial position and any concerns you may have about future solvency.</p>
                            </div>
                        </lightning-accordion-section>
                    </lightning-accordion>

                    <!-- Solvency Assessment -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small" title="Solvency Assessment">Solvency Assessment</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <div class="slds-form-element slds-m-bottom_medium">
                                <label class="slds-form-element__label">
                                    Are you currently concerned about the solvency of your organisation?
                                </label>
                                <div class="slds-form-element__control">
                                    <lightning-radio-group 
                                        name="solvencyConcern"
                                        options={yesNoOptions}
                                        value={formData.solvencyConcern}
                                        onchange={handleInputChange}
                                        type="button">
                                    </lightning-radio-group>
                                </div>
                            </div>
                            
                            <div class="slds-form-element slds-m-bottom_medium">
                                <label class="slds-form-element__label">
                                    Do you envisage any solvency issues arising in the next six months?
                                </label>
                                <div class="slds-form-element__control">
                                    <lightning-radio-group 
                                        name="futureSolvencyIssues"
                                        options={yesNoOptions}
                                        value={formData.futureSolvencyIssues}
                                        onchange={handleInputChange}
                                        type="button">
                                    </lightning-radio-group>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Performance Assessment -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small" title="Financial Performance">Financial Performance</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">
                                    Do you forecast an operational loss for the current year?
                                    <lightning-helptext content="An operational loss occurs when operating expenses exceed operating revenues from your core care services. Consider your year-to-date performance, budget forecasts, and any extraordinary items that may impact this year's results. This excludes investment income or one-time asset sales."></lightning-helptext>
                                </label>
                                <div class="slds-form-element__control">
                                    <lightning-radio-group 
                                        name="operationalLoss"
                                        options={yesNoOptions}
                                        value={formData.operationalLoss}
                                        onchange={handleInputChange}
                                        type="button">
                                    </lightning-radio-group>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Provider Contact Information -->
        <div if:true={isPage2} class="page-container">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Provider Contact Information</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Account Information -->
                    <div class="slds-section slds-m-bottom_large">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small" title="Account Information">Account Information</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <div class="slds-grid slds-wrap">
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-formatted-text value={accountInfo.organizationName} class="slds-text-heading_medium"></lightning-formatted-text>
                                    <p class="slds-text-body_small slds-text-color_weak">Organization Name</p>
                                </div>
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-formatted-text value={accountInfo.napsId} class="slds-text-heading_medium"></lightning-formatted-text>
                                    <p class="slds-text-body_small slds-text-color_weak">NAPS ID</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Primary Contact -->
                    <div class="slds-section">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small" title="Primary Contact">Primary Contact</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <div if:false={isEditingContact} class="contact-display">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-formatted-text value={contactInfo.name} class="slds-text-heading_small"></lightning-formatted-text>
                                        <p class="slds-text-body_small slds-text-color_weak">Name</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-formatted-text value={contactInfo.position} class="slds-text-heading_small"></lightning-formatted-text>
                                        <p class="slds-text-body_small slds-text-color_weak">Position</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-formatted-phone value={contactInfo.phone} class="slds-text-heading_small"></lightning-formatted-phone>
                                        <p class="slds-text-body_small slds-text-color_weak">Phone</p>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-formatted-email value={contactInfo.email} class="slds-text-heading_small"></lightning-formatted-email>
                                        <p class="slds-text-body_small slds-text-color_weak">Email</p>
                                    </div>
                                </div>
                                <div class="slds-m-top_medium">
                                    <lightning-button 
                                        label="Edit Contact Information" 
                                        onclick={handleEditContact}
                                        variant="neutral">
                                    </lightning-button>
                                </div>
                            </div>

                            <div if:true={isEditingContact} class="contact-edit">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input 
                                            label="Name" 
                                            value={contactInfo.name}
                                            name="name"
                                            onchange={handleContactChange}
                                            required>
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input 
                                            label="Position" 
                                            value={contactInfo.position}
                                            name="position"
                                            onchange={handleContactChange}
                                            required>
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input 
                                            label="Phone" 
                                            type="tel"
                                            value={contactInfo.phone}
                                            name="phone"
                                            onchange={handleContactChange}
                                            required>
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input 
                                            label="Email" 
                                            type="email"
                                            value={contactInfo.email}
                                            name="email"
                                            onchange={handleContactChange}
                                            required>
                                        </lightning-input>
                                    </div>
                                </div>
                                <div class="slds-m-top_medium">
                                    <lightning-button 
                                        label="Save" 
                                        onclick={handleSaveContact}
                                        variant="brand"
                                        class="slds-m-right_small">
                                    </lightning-button>
                                    <lightning-button 
                                        label="Cancel" 
                                        onclick={handleCancelEdit}
                                        variant="neutral">
                                    </lightning-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Business Structure Configuration -->
        <div if:true={isPage3} class="page-container">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Business Structure Configuration</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Business Structure Selection -->
                    <div class="slds-section slds-m-bottom_large">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small" title="Business Structure">Business Structure</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <template for:each={businessStructureOptions} for:item="option">
                                <div key={option.name} class="slds-form-element slds-m-bottom_medium">
                                    <div class="slds-grid slds-grid_align-spread">
                                        <div class="slds-col">
                                            <label class="slds-form-element__label">{option.label}</label>
                                        </div>
                                        <div class="slds-col slds-no-flex">
                                            <lightning-input 
                                                type="toggle"
                                                name={option.name}
                                                checked={option.selected}
                                                onchange={handleStructureToggle}>
                                            </lightning-input>
                                        </div>
                                    </div>
                                    
                                    <div if:true={option.selected} class="slds-m-top_medium slds-p-left_large">
                                        <lightning-checkbox-group 
                                            label="Service Types"
                                            options={serviceTypeOptions}
                                            value={option.serviceTypes}
                                            name={option.name}
                                            onchange={handleServiceTypeChange}>
                                        </lightning-checkbox-group>
                                        
                                        <div class="slds-m-top_medium">
                                            <lightning-textarea 
                                                label="Additional Information (Optional)"
                                                placeholder="Please provide percentage breakdowns and explanations..."
                                                value={option.additionalInfo}
                                                name={option.name}
                                                onchange={handleAdditionalInfoChange}>
                                            </lightning-textarea>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Workforce Configuration -->
                    <div class="slds-section">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small" title="Workforce">Workforce</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <lightning-combobox 
                                label="How are your direct care workers engaged?"
                                value={formData.workforceEngagement}
                                placeholder="Select workforce engagement method"
                                options={workforceOptions}
                                name="workforceEngagement"
                                onchange={handleInputChange}
                                required>
                            </lightning-combobox>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Labour Costs Data Management -->
        <div if:true={isPage4} class="page-container">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Labour Costs Data Management</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-section">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-horizontal_small" title="Labour Costs Data">Labour Costs Data</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <lightning-datatable
                                key-field="id"
                                data={labourCostData}
                                columns={labourCostColumns}
                                oncellchange={handleCellChange}
                                hide-checkbox-column="true"
                                show-row-number-column="false">
                            </lightning-datatable>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 5: Document Management and Submission -->
        <div if:true={isPage5} class="page-container">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Document Management and Submission</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Document Upload -->
                    <div class="slds-section slds-m-bottom_large">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small" title="Upload Documents">Upload Documents</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <div class="slds-grid slds-wrap slds-gutters slds-m-bottom_medium">
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-combobox 
                                        label="Document Category"
                                        value={uploadConfig.category}
                                        placeholder="Select category"
                                        options={documentCategories}
                                        name="category"
                                        onchange={handleUploadConfigChange}>
                                    </lightning-combobox>
                                </div>
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-combobox 
                                        label="Document Type"
                                        value={uploadConfig.type}
                                        placeholder="Select type"
                                        options={documentTypes}
                                        name="type"
                                        onchange={handleUploadConfigChange}>
                                    </lightning-combobox>
                                </div>
                            </div>
                            
                            <div class="file-upload-area" ondrop={handleFileDrop} ondragover={handleDragOver}>
                                <div class="slds-align_absolute-center slds-p-around_large">
                                    <lightning-icon icon-name="utility:upload" size="large" class="slds-m-bottom_small"></lightning-icon>
                                    <p class="slds-text-heading_medium">Drag and drop files here</p>
                                    <p class="slds-text-body_regular slds-m-bottom_medium">or</p>
                                    <lightning-button 
                                        label="Browse Files" 
                                        onclick={handleBrowseFiles}
                                        variant="neutral">
                                    </lightning-button>
                                    <input type="file" class="slds-hide" multiple onchange={handleFileSelect} data-id="fileInput">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Management -->
                    <div class="slds-section" if:true={hasUploadedFiles}>
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small" title="Uploaded Documents">Uploaded Documents</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <lightning-datatable
                                key-field="id"
                                data={uploadedFiles}
                                columns={fileColumns}
                                onrowaction={handleFileAction}
                                hide-checkbox-column="true">
                            </lightning-datatable>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="slds-docked-form-footer">
            <div class="slds-grid slds-grid_align-spread">
                <div class="slds-col">
                    <lightning-button 
                        label="Previous" 
                        onclick={handlePrevious}
                        variant="neutral"
                        disabled={isPreviousDisabled}>
                    </lightning-button>
                </div>
                <div class="slds-col slds-no-flex">
                    <lightning-button 
                        label={nextButtonLabel} 
                        onclick={handleNext}
                        variant="brand"
                        disabled={isNextDisabled}>
                    </lightning-button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div if:true={isLoading} class="slds-spinner_container">
            <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
        </div>
    </div>
</template>
