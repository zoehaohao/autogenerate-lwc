<template>
    <div class="qfr-form-container">
        <!-- Progress Indicator -->
        <lightning-progress-indicator 
            current-step={currentStep} 
            type="path" 
            variant="base">
            <lightning-progress-step 
                label="Residential Viability" 
                value="1">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Contact Information" 
                value="2">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Business Structure" 
                value="3">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Labour Costs" 
                value="4">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Document Management" 
                value="5">
            </lightning-progress-step>
        </lightning-progress-indicator>

        <!-- Page 1: Residential Viability and Prudential Reporting -->
        <div if:true={isPage1} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Residential Viability and Prudential Reporting</h2>
            </div>

            <!-- Information Section -->
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}
                class="info-accordion">
                <lightning-accordion-section name="about-section" label="About this section">
                    <div class="slds-p-around_medium">
                        <p class="slds-text-body_regular">
                            This section collects information about the financial health and viability of residential care services 
                            to identify providers who may need additional support or intervention. Your responses help us understand 
                            your organization's current financial position and any potential concerns that may require attention.
                        </p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <!-- Solvency Assessment -->
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Solvency Assessment</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label slds-text-body_regular">
                            Are you currently concerned about the solvency of your organisation?
                        </label>
                        <div class="slds-form-element__control">
                            <lightning-radio-group 
                                name="solvencyConcern"
                                options={yesNoOptions}
                                value={formData.solvencyConcern}
                                onchange={handleInputChange}
                                type="button"
                                class="radio-button-group">
                            </lightning-radio-group>
                        </div>
                    </div>

                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label slds-text-body_regular">
                            Do you envisage any solvency issues arising in the next six months?
                        </label>
                        <div class="slds-form-element__control">
                            <lightning-radio-group 
                                name="futureSolvencyIssues"
                                options={yesNoOptions}
                                value={formData.futureSolvencyIssues}
                                onchange={handleInputChange}
                                type="button"
                                class="radio-button-group">
                            </lightning-radio-group>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Performance Assessment -->
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Financial Performance Assessment</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-form-element">
                        <label class="slds-form-element__label slds-text-body_regular">
                            Do you forecast an operational loss for the current year?
                            <lightning-helptext 
                                content="An operational loss occurs when operating expenses exceed operating revenues from your core care services. Consider your year-to-date performance, budget forecasts, and any extraordinary items that may impact this year's results. This excludes investment income or one-time asset sales."
                                icon-name="utility:info">
                            </lightning-helptext>
                        </label>
                        <div class="slds-form-element__control">
                            <lightning-radio-group 
                                name="operationalLoss"
                                options={yesNoOptions}
                                value={formData.operationalLoss}
                                onchange={handleInputChange}
                                type="button"
                                class="radio-button-group">
                            </lightning-radio-group>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Provider Contact Information -->
        <div if:true={isPage2} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Provider Contact Information</h2>
            </div>

            <!-- Account Information -->
            <div class="slds-card">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Account Information</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-grid slds-wrap">
                        <div class="slds-col slds-size_1-of-2 slds-p-right_small">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">Organization Name</label>
                                <div class="slds-form-element__control">
                                    <span class="slds-form-element__static">{formData.organizationName}</span>
                                </div>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">NAPS ID</label>
                                <div class="slds-form-element__control">
                                    <span class="slds-form-element__static">{formData.napsId}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Primary Contact -->
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid slds-grid_align-spread">
                    <h3 class="slds-card__header-title slds-text-heading_small">Primary Contact</h3>
                    <lightning-button 
                        label={editButtonLabel}
                        variant={editButtonVariant}
                        onclick={handleEditContact}
                        class="edit-button">
                    </lightning-button>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div if:false={isEditingContact} class="contact-display">
                        <div class="slds-grid slds-wrap">
                            <div class="slds-col slds-size_1-of-2 slds-p-right_small">
                                <div class="slds-form-element slds-m-bottom_small">
                                    <label class="slds-form-element__label">Name</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-form-element__static">{formData.contactName}</span>
                                    </div>
                                </div>
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Phone</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-form-element__static">{formData.contactPhone}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                                <div class="slds-form-element slds-m-bottom_small">
                                    <label class="slds-form-element__label">Position</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-form-element__static">{formData.contactPosition}</span>
                                    </div>
                                </div>
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Email</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-form-element__static">{formData.contactEmail}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div if:true={isEditingContact} class="contact-edit">
                        <div class="slds-grid slds-wrap">
                            <div class="slds-col slds-size_1-of-2 slds-p-right_small">
                                <lightning-input 
                                    label="Name"
                                    name="contactName"
                                    value={formData.contactName}
                                    onchange={handleInputChange}
                                    required
                                    class="slds-m-bottom_small">
                                </lightning-input>
                                <lightning-input 
                                    label="Phone"
                                    name="contactPhone"
                                    type="tel"
                                    value={formData.contactPhone}
                                    onchange={handleInputChange}
                                    required>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                                <lightning-input 
                                    label="Position"
                                    name="contactPosition"
                                    value={formData.contactPosition}
                                    onchange={handleInputChange}
                                    required
                                    class="slds-m-bottom_small">
                                </lightning-input>
                                <lightning-input 
                                    label="Email"
                                    name="contactEmail"
                                    type="email"
                                    value={formData.contactEmail}
                                    onchange={handleInputChange}
                                    required>
                                </lightning-input>
                            </div>
                        </div>
                        <div class="slds-m-top_medium">
                            <lightning-button 
                                label="Save"
                                variant="brand"
                                onclick={handleSaveContact}
                                class="slds-m-right_small">
                            </lightning-button>
                            <lightning-button 
                                label="Cancel"
                                variant="neutral"
                                onclick={handleCancelEdit}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Business Structure Configuration -->
        <div if:true={isPage3} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Business Structure Configuration</h2>
            </div>

            <!-- Business Structure Selection -->
            <div class="slds-card">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Business Structure Types</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <template for:each={businessStructureTypes} for:item="structureType">
                        <div key={structureType.name} class="structure-type-section slds-m-bottom_large">
                            <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                <label class="slds-form-element__label slds-text-body_regular">
                                    {structureType.label}
                                </label>
                                <lightning-input 
                                    type="toggle"
                                    name={structureType.name}
                                    checked={structureType.selected}
                                    onchange={handleStructureToggle}
                                    variant="label-hidden">
                                </lightning-input>
                            </div>
                            
                            <div if:true={structureType.selected} class="structure-details slds-p-left_medium">
                                <div class="slds-form-element slds-m-bottom_medium">
                                    <label class="slds-form-element__label">Service Types</label>
                                    <lightning-checkbox-group 
                                        name={structureType.serviceTypesName}
                                        options={serviceTypeOptions}
                                        value={structureType.serviceTypes}
                                        onchange={handleServiceTypeChange}>
                                    </lightning-checkbox-group>
                                </div>
                                
                                <lightning-textarea 
                                    label="Additional Information (percentage breakdowns, explanations)"
                                    name={structureType.additionalInfoName}
                                    value={structureType.additionalInfo}
                                    onchange={handleAdditionalInfoChange}
                                    placeholder="Please provide percentage breakdowns and any additional explanations..."
                                    class="slds-m-bottom_medium">
                                </lightning-textarea>

                                <div class="qa-comments slds-box slds-theme_shade">
                                    <label class="slds-form-element__label slds-text-body_small">QA Assessor Comments</label>
                                    <div class="slds-text-body_small slds-text-color_weak">
                                        No comments available
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Workforce Configuration -->
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Workforce Configuration</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <lightning-combobox 
                        label="How are your direct care workers engaged?"
                        name="workforceEngagement"
                        value={formData.workforceEngagement}
                        options={workforceOptions}
                        onchange={handleInputChange}
                        placeholder="Select workforce engagement method"
                        required>
                    </lightning-combobox>
                </div>
            </div>
        </div>

        <!-- Page 4: Labour Costs Data Management -->
        <div if:true={isPage4} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Labour Costs Data Management</h2>
            </div>

            <!-- Table Controls -->
            <div class="slds-card">
                <div class="slds-card__header">
                    <div class="slds-grid slds-grid_align-spread">
                        <h3 class="slds-card__header-title slds-text-heading_small">Labour Costs Data</h3>
                        <div class="table-controls slds-grid slds-gutters_small">
                            <div class="slds-col">
                                <lightning-combobox 
                                    label="View All"
                                    name="tableFilter"
                                    value={tableFilter}
                                    options={tableFilterOptions}
                                    onchange={handleTableFilter}
                                    variant="label-hidden"
                                    placeholder="All Rows">
                                </lightning-combobox>
                            </div>
                            <div class="slds-col">
                                <lightning-combobox 
                                    label="Jump to Section"
                                    name="jumpToSection"
                                    value={jumpToSection}
                                    options={sectionOptions}
                                    onchange={handleJumpToSection}
                                    variant="label-hidden"
                                    placeholder="Jump to Section">
                                </lightning-combobox>
                            </div>
                            <div class="slds-col">
                                <lightning-combobox 
                                    label="Jump to Column"
                                    name="jumpToColumn"
                                    value={jumpToColumn}
                                    options={columnOptions}
                                    onchange={handleJumpToColumn}
                                    variant="label-hidden"
                                    placeholder="Jump to Column">
                                </lightning-combobox>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-form-element slds-m-bottom_medium">
                        <lightning-input 
                            type="toggle"
                            label="Centrally Held"
                            name="centrallyHeld"
                            checked={formData.centrallyHeld}
                            onchange={handleInputChange}>
                        </lightning-input>
                    </div>
                    
                    <lightning-datatable 
                        key-field="id"
                        data={filteredLabourData}
                        columns={labourCostColumns}
                        oncellchange={handleLabourCostChange}
                        hide-checkbox-column="true"
                        class="labour-costs-table">
                    </lightning-datatable>
                </div>
            </div>
        </div>

        <!-- Page 5: Document Management and Submission -->
        <div if:true={isPage5} class="page-container">
            <div class="page-header">
                <h2 class="slds-text-heading_large">Document Management and Submission</h2>
            </div>

            <!-- Document Upload -->
            <div class="slds-card">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Document Upload</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-grid slds-wrap slds-m-bottom_medium">
                        <div class="slds-col slds-size_1-of-2 slds-p-right_small">
                            <lightning-combobox 
                                label="Document Category"
                                name="documentCategory"
                                value={selectedDocumentCategory}
                                options={documentCategoryOptions}
                                onchange={handleDocumentCategoryChange}
                                placeholder="Select category"
                                required>
                            </lightning-combobox>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                            <lightning-combobox 
                                label="Document Type"
                                name="documentType"
                                value={selectedDocumentType}
                                options={documentTypeOptions}
                                onchange={handleDocumentTypeChange}
                                placeholder="Select type"
                                required>
                            </lightning-combobox>
                        </div>
                    </div>

                    <div class="file-upload-area slds-box slds-box_small slds-theme_shade slds-text-align_center">
                        <lightning-input 
                            type="file"
                            name="fileUpload"
                            label="Upload Files"
                            onchange={handleFileUpload}
                            multiple
                            accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"
                            variant="label-hidden">
                        </lightning-input>
                        <div class="upload-instructions slds-m-top_small">
                            <p class="slds-text-body_regular">Drag and drop files here or click to browse</p>
                            <p class="slds-text-body_small slds-text-color_weak">
                                Supported formats: PDF, Word, Excel, Images (Max 10MB per file)
                            </p>
                        </div>
                    </div>

                    <div if:true={isUploading} class="slds-m-top_medium">
                        <lightning-spinner alternative-text="Uploading files..." size="small"></lightning-spinner>
                    </div>
                </div>
            </div>

            <!-- Document Management -->
            <div class="slds-card slds-m-top_medium" if:true={hasUploadedFiles}>
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title slds-text-heading_small">Uploaded Documents</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <lightning-datatable 
                        key-field="id"
                        data={uploadedFiles}
                        columns={documentColumns}
                        onrowaction={handleDocumentAction}
                        hide-checkbox-column="true">
                    </lightning-datatable>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons slds-m-top_large slds-grid slds-grid_align-spread">
            <lightning-button 
                label="Previous"
                variant="neutral"
                onclick={handlePrevious}
                disabled={isPreviousDisabled}
                class="previous-button">
            </lightning-button>
            
            <div class="next-button-container">
                <lightning-spinner if:true={isLoading} alternative-text="Processing..." size="small" class="slds-m-right_small"></lightning-spinner>
                <lightning-button 
                    label={nextButtonLabel}
                    variant="brand"
                    onclick={handleNext}
                    disabled={isNextDisabled}
                    class="next-button">
                </lightning-button>
            </div>
        </div>

        <!-- Error Messages -->
        <div if:true={hasErrors} class="slds-m-top_medium">
            <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
                <span class="slds-assistive-text">Error</span>
                <div class="slds-notify__content">
                    <h2>Please correct the following errors:</h2>
                    <ul class="slds-list_dotted">
                        <template for:each={errorMessages} for:item="error">
                            <li key={error}>{error}</li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</template>
