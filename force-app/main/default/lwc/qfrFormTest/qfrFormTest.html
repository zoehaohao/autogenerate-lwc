<template>
    <div class="qfr-form-container">
        <div class="form-header">
            <h1 class="form-title">Quarterly Financial Review Form</h1>
            <p class="form-description">Please complete all sections of this quarterly financial review assessment.</p>
        </div>

        <lightning-progress-indicator 
            current-step={currentStep} 
            type="path" 
            variant="base">
            <lightning-progress-step 
                label="Financial Health" 
                value="step1">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Risk Assessment" 
                value="step2">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Performance Metrics" 
                value="step3">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Review & Submit" 
                value="step4">
            </lightning-progress-step>
        </lightning-progress-indicator>

        <div class="form-content">
            <template if:true={isStep1}>
                <div class="step-section">
                    <h2 class="section-title">Financial Health Assessment</h2>
                    
                    <lightning-accordion 
                        active-section-name={openSections} 
                        allow-multiple-sections-open="true"
                        onselect={handleAccordionToggle}>
                        
                        <lightning-accordion-section name="happiness" label="General Assessment">
                            <div class="form-group">
                                <lightning-radio-group 
                                    name="happinessLevel"
                                    label="Are you happy ?"
                                    options={happinessOptions}
                                    value={formData.happinessLevel}
                                    onchange={handleInputChange}
                                    required="true"
                                    class="required-field">
                                </lightning-radio-group>
                            </div>

                            <div class="form-group">
                                <lightning-textarea 
                                    name="happinessComments"
                                    label="Please provide additional comments about your current satisfaction level"
                                    value={formData.happinessComments}
                                    onchange={handleInputChange}
                                    placeholder="Enter your comments here..."
                                    rows="4">
                                </lightning-textarea>
                            </div>
                        </lightning-accordion-section>

                        <lightning-accordion-section name="financial" label="Financial Position">
                            <div class="form-group">
                                <lightning-input 
                                    type="number"
                                    name="currentRevenue"
                                    label="Current Quarter Revenue"
                                    value={formData.currentRevenue}
                                    onchange={handleInputChange}
                                    formatter="currency"
                                    required="true"
                                    class="required-field">
                                </lightning-input>
                            </div>

                            <div class="form-group">
                                <lightning-input 
                                    type="number"
                                    name="previousRevenue"
                                    label="Previous Quarter Revenue"
                                    value={formData.previousRevenue}
                                    onchange={handleInputChange}
                                    formatter="currency"
                                    required="true"
                                    class="required-field">
                                </lightning-input>
                            </div>

                            <div class="form-group">
                                <lightning-combobox 
                                    name="cashFlowStatus"
                                    label="Cash Flow Status"
                                    value={formData.cashFlowStatus}
                                    placeholder="Select cash flow status"
                                    options={cashFlowOptions}
                                    onchange={handleInputChange}
                                    required="true"
                                    class="required-field">
                                </lightning-combobox>
                            </div>
                        </lightning-accordion-section>
                    </lightning-accordion>
                </div>
            </template>

            <template if:true={isStep2}>
                <div class="step-section">
                    <h2 class="section-title">Risk Assessment</h2>
                    
                    <lightning-accordion 
                        active-section-name={openSections} 
                        allow-multiple-sections-open="true"
                        onselect={handleAccordionToggle}>
                        
                        <lightning-accordion-section name="risks" label="Risk Factors">
                            <div class="form-group">
                                <lightning-checkbox-group 
                                    name="riskFactors"
                                    label="Select all applicable risk factors"
                                    options={riskFactorOptions}
                                    value={formData.riskFactors}
                                    onchange={handleInputChange}>
                                </lightning-checkbox-group>
                            </div>

                            <div class="form-group">
                                <lightning-combobox 
                                    name="overallRiskLevel"
                                    label="Overall Risk Level"
                                    value={formData.overallRiskLevel}
                                    placeholder="Select risk level"
                                    options={riskLevelOptions}
                                    onchange={handleInputChange}
                                    required="true"
                                    class="required-field">
                                </lightning-combobox>
                            </div>
                        </lightning-accordion-section>
                    </lightning-accordion>
                </div>
            </template>

            <template if:true={isStep3}>
                <div class="step-section">
                    <h2 class="section-title">Performance Metrics</h2>
                    
                    <div class="metrics-table">
                        <lightning-datatable 
                            key-field="id"
                            data={performanceData}
                            columns={performanceColumns}
                            oncellchange={handleCellChange}
                            draft-values={draftValues}
                            hide-checkbox-column="true">
                        </lightning-datatable>
                    </div>

                    <div class="form-group">
                        <lightning-textarea 
                            name="performanceNotes"
                            label="Performance Analysis Notes"
                            value={formData.performanceNotes}
                            onchange={handleInputChange}
                            placeholder="Enter your analysis of the performance metrics..."
                            rows="6">
                        </lightning-textarea>
                    </div>
                </div>
            </template>

            <template if:true={isStep4}>
                <div class="step-section">
                    <h2 class="section-title">Review & Submit</h2>
                    
                    <div class="review-summary">
                        <h3>Form Summary</h3>
                        <div class="summary-item">
                            <strong>Happiness Level:</strong> {formData.happinessLevel}
                        </div>
                        <div class="summary-item">
                            <strong>Current Revenue:</strong> {formattedCurrentRevenue}
                        </div>
                        <div class="summary-item">
                            <strong>Cash Flow Status:</strong> {formData.cashFlowStatus}
                        </div>
                        <div class="summary-item">
                            <strong>Risk Level:</strong> {formData.overallRiskLevel}
                        </div>
                    </div>

                    <div class="form-group">
                        <lightning-input 
                            type="checkbox"
                            name="confirmAccuracy"
                            label="I confirm that all information provided is accurate and complete"
                            checked={formData.confirmAccuracy}
                            onchange={handleInputChange}
                            required="true"
                            class="required-field">
                        </lightning-input>
                    </div>
                </div>
            </template>
        </div>

        <div class="form-actions">
            <template if:false={isFirstStep}>
                <lightning-button 
                    variant="neutral"
                    label="Previous"
                    onclick={handlePrevious}
                    disabled={isLoading}>
                </lightning-button>
            </template>

            <template if:false={isLastStep}>
                <lightning-button 
                    variant="brand"
                    label="Next"
                    onclick={handleNext}
                    disabled={nextButtonDisabled}>
                </lightning-button>
            </template>

            <template if:true={isLastStep}>
                <lightning-button 
                    variant="brand"
                    label="Submit Form"
                    onclick={handleSubmit}
                    disabled={submitButtonDisabled}>
                </lightning-button>
            </template>

            <template if:true={isLoading}>
                <lightning-spinner 
                    alternative-text="Processing..."
                    size="small">
                </lightning-spinner>
            </template>
        </div>

        <template if:true={showSuccessMessage}>
            <div class="success-message">
                <lightning-icon 
                    icon-name="utility:success"
                    size="small"
                    variant="success">
                </lightning-icon>
                <span>Form submitted successfully!</span>
            </div>
        </template>

        <template if:true={errorMessage}>
            <div class="error-message">
                <lightning-icon 
                    icon-name="utility:error"
                    size="small"
                    variant="error">
                </lightning-icon>
                <span>{errorMessage}</span>
            </div>
        </template>
    </div>
</template>
