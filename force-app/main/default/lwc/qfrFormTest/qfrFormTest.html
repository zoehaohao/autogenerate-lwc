<template>
    <div class="qfr-form-container">
        <!-- Progress Indicator -->
        <lightning-progress-indicator 
            current-step={currentStep} 
            type="path" 
            variant="base">
            <lightning-progress-step 
                label="Residential Viability" 
                value="1">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Contact Information" 
                value="2">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Business Structure" 
                value="3">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Labour Costs" 
                value="4">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Document Management" 
                value="5">
            </lightning-progress-step>
        </lightning-progress-indicator>

        <!-- Page 1: Residential Viability and Prudential Reporting -->
        <div if:true={isPage1} class="page-content">
            <h2 class="page-title">Residential Viability and Prudential Reporting</h2>
            
            <!-- Information Section -->
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}>
                <lightning-accordion-section name="about-section" label="About this section">
                    <div class="info-content">
                        <p>This section collects information about the financial health and viability of residential care services to identify providers who may need additional support or intervention.</p>
                        <p>Your responses help us understand your organization's current financial position and any concerns that may require attention.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <!-- Solvency Assessment -->
            <div class="section-card">
                <h3 class="section-title">Solvency Assessment</h3>
                
                <div class="question-group">
                    <label class="question-label">Are you currently concerned about the solvency of your organisation?</label>
                    <div class="button-group">
                        <button 
                            class={solvencyConcernYesClass} 
                            onclick={handleSolvencyConcernYes}>
                            Yes
                        </button>
                        <button 
                            class={solvencyConcernNoClass} 
                            onclick={handleSolvencyConcernNo}>
                            No
                        </button>
                    </div>
                    <div if:true={showSolvencyConcernError} class="error-message">
                        This field is required
                    </div>
                </div>

                <div class="question-group">
                    <label class="question-label">Do you envisage any solvency issues arising in the next six months?</label>
                    <div class="button-group">
                        <button 
                            class={solvencyFutureYesClass} 
                            onclick={handleSolvencyFutureYes}>
                            Yes
                        </button>
                        <button 
                            class={solvencyFutureNoClass} 
                            onclick={handleSolvencyFutureNo}>
                            No
                        </button>
                    </div>
                    <div if:true={showSolvencyFutureError} class="error-message">
                        This field is required
                    </div>
                </div>
            </div>

            <!-- Financial Performance Assessment -->
            <div class="section-card">
                <h3 class="section-title">Financial Performance Assessment</h3>
                
                <div class="question-group">
                    <div class="question-with-tooltip">
                        <label class="question-label">Do you forecast an operational loss for the current year?</label>
                        <lightning-helptext 
                            content="An operational loss occurs when operating expenses exceed operating revenues from your core care services. Consider your year-to-date performance, budget forecasts, and any extraordinary items that may impact this year's results. This excludes investment income or one-time asset sales.">
                        </lightning-helptext>
                    </div>
                    <div class="button-group">
                        <button 
                            class={operationalLossYesClass} 
                            onclick={handleOperationalLossYes}>
                            Yes
                        </button>
                        <button 
                            class={operationalLossNoClass} 
                            onclick={handleOperationalLossNo}>
                            No
                        </button>
                    </div>
                    <div if:true={showOperationalLossError} class="error-message">
                        This field is required
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Provider Contact Information -->
        <div if:true={isPage2} class="page-content">
            <h2 class="page-title">Provider Contact Information</h2>
            
            <!-- Information Section -->
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}>
                <lightning-accordion-section name="contact-info" label="About this section">
                    <div class="info-content">
                        <p>Please ensure we have current, accurate contact information for the primary person responsible for the QFR submission and any follow-up communications.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <!-- Account Information -->
            <div class="section-card">
                <h3 class="section-title">Account Information</h3>
                <div class="account-info">
                    <div class="info-row">
                        <span class="info-label">Organisation Name:</span>
                        <span class="info-value">{accountName}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">NAPS ID:</span>
                        <span class="info-value">{napsId}</span>
                    </div>
                </div>
            </div>

            <!-- Primary Contact -->
            <div class="section-card">
                <h3 class="section-title">Primary Contact</h3>
                <div if:false={isEditingContact} class="contact-display">
                    <div class="info-row">
                        <span class="info-label">Name:</span>
                        <span class="info-value">{contactName}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Position:</span>
                        <span class="info-value">{contactPosition}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Phone:</span>
                        <span class="info-value">{contactPhone}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value">{contactEmail}</span>
                    </div>
                    <button class="edit-button" onclick={handleEditContact}>Edit</button>
                </div>

                <div if:true={isEditingContact} class="contact-edit">
                    <lightning-input 
                        label="Name" 
                        value={editContactName} 
                        onchange={handleContactNameChange}
                        required>
                    </lightning-input>
                    <lightning-input 
                        label="Position" 
                        value={editContactPosition} 
                        onchange={handleContactPositionChange}
                        required>
                    </lightning-input>
                    <lightning-input 
                        label="Phone" 
                        type="tel" 
                        value={editContactPhone} 
                        onchange={handleContactPhoneChange}
                        required>
                    </lightning-input>
                    <lightning-input 
                        label="Email" 
                        type="email" 
                        value={editContactEmail} 
                        onchange={handleContactEmailChange}
                        required>
                    </lightning-input>
                    <div class="button-group">
                        <button class="save-button" onclick={handleSaveContact}>Save</button>
                        <button class="cancel-button" onclick={handleCancelEdit}>Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Business Structure Configuration -->
        <div if:true={isPage3} class="page-content">
            <h2 class="page-title">Business Structure Configuration</h2>
            
            <!-- Information Section -->
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}>
                <lightning-accordion-section name="business-structure-info" label="About this section">
                    <div class="info-content">
                        <p>Help us understand how you organize your service delivery to ensure appropriate regulatory oversight and support.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <!-- Business Structure Selection -->
            <div class="section-card">
                <h3 class="section-title">Business Structure Types</h3>
                
                <!-- In-house delivery -->
                <div class="structure-item">
                    <div class="structure-header">
                        <label class="structure-label">In-house delivery</label>
                        <div class="toggle-container">
                            <button 
                                class={inHouseToggleClass} 
                                onclick={handleInHouseToggle}>
                                {inHouseToggleLabel}
                            </button>
                        </div>
                    </div>
                    <div if:true={showInHouseDetails} class="structure-details">
                        <lightning-checkbox-group 
                            label="Service Types" 
                            options={serviceTypeOptions} 
                            value={inHouseServiceTypes} 
                            onchange={handleInHouseServiceChange}>
                        </lightning-checkbox-group>
                        <lightning-textarea 
                            label="Additional Information" 
                            value={inHouseAdditionalInfo} 
                            onchange={handleInHouseAdditionalInfoChange}
                            placeholder="Please provide percentage breakdowns and explanations">
                        </lightning-textarea>
                    </div>
                </div>

                <!-- Franchisee -->
                <div class="structure-item">
                    <div class="structure-header">
                        <label class="structure-label">Franchisee</label>
                        <div class="toggle-container">
                            <button 
                                class={franchiseeToggleClass} 
                                onclick={handleFranchiseeToggle}>
                                {franchiseeToggleLabel}
                            </button>
                        </div>
                    </div>
                    <div if:true={showFranchiseeDetails} class="structure-details">
                        <lightning-checkbox-group 
                            label="Service Types" 
                            options={serviceTypeOptions} 
                            value={franchiseeServiceTypes} 
                            onchange={handleFranchiseeServiceChange}>
                        </lightning-checkbox-group>
                        <lightning-textarea 
                            label="Additional Information" 
                            value={franchiseeAdditionalInfo} 
                            onchange={handleFranchiseeAdditionalInfoChange}
                            placeholder="Please provide percentage breakdowns and explanations">
                        </lightning-textarea>
                    </div>
                </div>

                <!-- Franchisor -->
                <div class="structure-item">
                    <div class="structure-header">
                        <label class="structure-label">Franchisor</label>
                        <div class="toggle-container">
                            <button 
                                class={franchisorToggleClass} 
                                onclick={handleFranchisorToggle}>
                                {franchisorToggleLabel}
                            </button>
                        </div>
                    </div>
                    <div if:true={showFranchisorDetails} class="structure-details">
                        <lightning-checkbox-group 
                            label="Service Types" 
                            options={serviceTypeOptions} 
                            value={franchisorServiceTypes} 
                            onchange={handleFranchisorServiceChange}>
                        </lightning-checkbox-group>
                    </div>
                </div>

                <!-- Brokerage -->
                <div class="structure-item">
                    <div class="structure-header">
                        <label class="structure-label">Brokerage</label>
                        <div class="toggle-container">
                            <button 
                                class={brokerageToggleClass} 
                                onclick={handleBrokerageToggle}>
                                {brokerageToggleLabel}
                            </button>
                        </div>
                    </div>
                    <div if:true={showBrokerageDetails} class="structure-details">
                        <lightning-checkbox-group 
                            label="Service Types" 
                            options={serviceTypeOptions} 
                            value={brokerageServiceTypes} 
                            onchange={handleBrokerageServiceChange}>
                        </lightning-checkbox-group>
                    </div>
                </div>

                <!-- Subcontractor -->
                <div class="structure-item">
                    <div class="structure-header">
                        <label class="structure-label">Subcontractor</label>
                        <div class="toggle-container">
                            <button 
                                class={subcontractorToggleClass} 
                                onclick={handleSubcontractorToggle}>
                                {subcontractorToggleLabel}
                            </button>
                        </div>
                    </div>
                    <div if:true={showSubcontractorDetails} class="structure-details">
                        <lightning-checkbox-group 
                            label="Service Types" 
                            options={serviceTypeOptions} 
                            value={subcontractorServiceTypes} 
                            onchange={handleSubcontractorServiceChange}>
                        </lightning-checkbox-group>
                    </div>
                </div>

                <!-- Self-employ individual -->
                <div class="structure-item">
                    <div class="structure-header">
                        <label class="structure-label">Self-employ individual</label>
                        <div class="toggle-container">
                            <button 
                                class={selfEmployToggleClass} 
                                onclick={handleSelfEmployToggle}>
                                {selfEmployToggleLabel}
                            </button>
                        </div>
                    </div>
                    <div if:true={showSelfEmployDetails} class="structure-details">
                        <lightning-checkbox-group 
                            label="Service Types" 
                            options={serviceTypeOptions} 
                            value={selfEmployServiceTypes} 
                            onchange={handleSelfEmployServiceChange}>
                        </lightning-checkbox-group>
                    </div>
                </div>

                <!-- Other -->
                <div class="structure-item">
                    <div class="structure-header">
                        <label class="structure-label">Other</label>
                        <div class="toggle-container">
                            <button 
                                class={otherToggleClass} 
                                onclick={handleOtherToggle}>
                                {otherToggleLabel}
                            </button>
                        </div>
                    </div>
                    <div if:true={showOtherDetails} class="structure-details">
                        <lightning-checkbox-group 
                            label="Service Types" 
                            options={serviceTypeOptions} 
                            value={otherServiceTypes} 
                            onchange={handleOtherServiceChange}>
                        </lightning-checkbox-group>
                        <lightning-textarea 
                            label="Please specify" 
                            value={otherSpecification} 
                            onchange={handleOtherSpecificationChange}
                            placeholder="Please describe your business structure">
                        </lightning-textarea>
                    </div>
                </div>
            </div>

            <!-- Workforce Configuration -->
            <div class="section-card">
                <h3<h3 class="section-title">Workforce Configuration</h3>
                <lightning-combobox 
                    label="How are your direct care workers engaged?" 
                    value={workforceEngagement} 
                    placeholder="Select engagement type" 
                    options={workforceOptions} 
                    onchange={handleWorkforceChange}
                    required>
                </lightning-combobox>
            </div>
        </div>

        <!-- Page 4: Labour Costs Data Management -->
        <div if:true={isPage4} class="page-content">
            <h2 class="page-title">Labour Costs Data Management</h2>
            
            <!-- Information Section -->
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}>
                <lightning-accordion-section name="labour-costs-info" label="About this section">
                    <div class="info-content">
                        <p>Capture detailed breakdown of internal direct care labour costs to assess provider workforce composition and cost structures for regulatory oversight and benchmarking.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <!-- Table Controls -->
            <div class="table-controls">
                <lightning-combobox 
                    label="View All" 
                    value={tableFilter} 
                    options={filterOptions} 
                    onchange={handleFilterChange}>
                </lightning-combobox>
                
                <lightning-combobox 
                    label="Jump to Section" 
                    value={selectedSection} 
                    options={sectionOptions} 
                    onchange={handleSectionJump}>
                </lightning-combobox>
                
                <lightning-combobox 
                    label="Jump to Column" 
                    value={selectedColumn} 
                    options={columnOptions} 
                    onchange={handleColumnJump}>
                </lightning-combobox>
            </div>

            <!-- Centrally Held Toggle -->
            <div class="centrally-held-section">
                <label class="toggle-label">Centrally Held</label>
                <button 
                    class={centrallyHeldToggleClass} 
                    onclick={handleCentrallyHeldToggle}>
                    {centrallyHeldToggleLabel}
                </button>
            </div>

            <!-- Labour Costs Data Table -->
            <div class="data-table-container">
                <lightning-datatable 
                    key-field="id" 
                    data={labourCostsData} 
                    columns={labourCostsColumns} 
                    oncellchange={handleCellChange}
                    hide-checkbox-column="true">
                </lightning-datatable>
            </div>
        </div>

        <!-- Page 5: Document Management and Submission -->
        <div if:true={isPage5} class="page-content">
            <h2 class="page-title">Document Management and Submission</h2>
            
            <!-- Information Section -->
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}>
                <lightning-accordion-section name="document-info" label="About this section">
                    <div class="info-content">
                        <p>Upload required supporting documentation and finalize your QFR submission with proper document categorization and tracking.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <!-- Document Upload Configuration -->
            <div class="section-card">
                <h3 class="section-title">Document Upload</h3>
                
                <div class="upload-config">
                    <lightning-combobox 
                        label="Document Category" 
                        value={selectedCategory} 
                        options={categoryOptions} 
                        onchange={handleCategoryChange}
                        required>
                    </lightning-combobox>
                    
                    <lightning-combobox 
                        label="Document Type" 
                        value={selectedDocType} 
                        options={docTypeOptions} 
                        onchange={handleDocTypeChange}
                        required>
                    </lightning-combobox>
                </div>

                <!-- File Upload Interface -->
                <div class="upload-area" ondrop={handleFileDrop} ondragover={handleDragOver}>
                    <div class="upload-content">
                        <div class="upload-icon">📁</div>
                        <p class="upload-text">Drag and drop files here or</p>
                        <button class="browse-button" onclick={handleBrowseFiles}>Browse Files</button>
                        <input 
                            type="file" 
                            class="file-input" 
                            onchange={handleFileSelect} 
                            multiple 
                            accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                    </div>
                </div>

                <div if:true={isUploading} class="upload-progress">
                    <lightning-spinner alternative-text="Uploading files..."></lightning-spinner>
                    <p>Uploading files...</p>
                </div>
            </div>

            <!-- Document Management -->
            <div class="section-card">
                <h3 class="section-title">Uploaded Documents</h3>
                
                <div if:true={hasUploadedFiles} class="document-table">
                    <lightning-datatable 
                        key-field="id" 
                        data={uploadedFiles} 
                        columns={fileColumns} 
                        onrowaction={handleFileAction}
                        hide-checkbox-column="true">
                    </lightning-datatable>
                </div>
                
                <div if:false={hasUploadedFiles} class="no-files-message">
                    <p>No documents uploaded yet. Please upload at least one document to proceed.</p>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
            <button 
                class="nav-button previous-button" 
                onclick={handlePrevious} 
                disabled={isPreviousDisabled}>
                Previous
            </button>
            
            <button 
                class="nav-button next-button" 
                onclick={handleNext} 
                disabled={isNextDisabled}>
                {nextButtonLabel}
            </button>
        </div>

        <!-- Loading Spinner -->
        <div if:true={isLoading} class="loading-overlay">
            <lightning-spinner alternative-text="Processing..."></lightning-spinner>
        </div>
    </div>
</template>
