<template>
    <div class="qfr-form-container">
        <!-- Progress Indicator -->
        <lightning-progress-indicator 
            current-step={currentStep} 
            type="path" 
            variant="base">
            <lightning-progress-step 
                label="Residential Viability" 
                value="1">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Contact Information" 
                value="2">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Business Structure" 
                value="3">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Labour Costs" 
                value="4">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Document Management" 
                value="5">
            </lightning-progress-Step>
        </lightning-progress-indicator>

        <!-- Page 1: Residential Viability and Prudential Reporting -->
        <div if:true={isPage1} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Residential Viability and Prudential Reporting</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- About this section accordion -->
                    <lightning-accordion 
                        active-section-name={openSections} 
                        allow-multiple-sections-open="true"
                        onselect={handleAccordionToggle}>
                        <lightning-accordion-section name="about-section" label="About this section">
                            <div class="slds-p-around_medium">
                                <p>This section collects information about the financial health and viability of residential care services to identify providers who may need additional support or intervention. The data helps ensure appropriate regulatory oversight and support for healthcare providers.</p>
                            </div>
                        </lightning-accordion-section>
                    </lightning-accordion>

                    <!-- Solvency Questions -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small">Solvency Assessment</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <div class="slds-form-element slds-m-bottom_medium">
                                <label class="slds-form-element__label">
                                    <span class="required-asterisk">*</span>
                                    Are you currently concerned about the solvency of your organisation?
                                </label>
                                <lightning-radio-group 
                                    name="solvencyConcern"
                                    options={yesNoOptions}
                                    value={formData.solvencyConcern}
                                    onchange={handleInputChange}
                                    type="button"
                                    required="true">
                                </lightning-radio-group>
                            </div>
                            
                            <div class="slds-form-element slds-m-bottom_medium">
                                <label class="slds-form-element__label">
                                    <span class="required-asterisk">*</span>
                                    Do you envisage any solvency issues arising in the next six months?
                                </label>
                                <lightning-radio-group 
                                    name="futureSolvencyIssues"
                                    options={yesNoOptions}
                                    value={formData.futureSolvencyIssues}
                                    onchange={handleInputChange}
                                    type="button"
                                    required="true">
                                </lightning-radio-group>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Performance -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title slds-theme_shade">
                            <span class="slds-truncate slds-p-horizontal_small">Financial Performance Assessment</span>
                        </h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">
                                    <span class="required-asterisk">*</span>
                                    Do you forecast an operational loss for the current year?
                                    <lightning-helptext 
                                        content="An operational loss occurs when operating expenses exceed operating revenues from your core care services. Consider your year-to-date performance, budget forecasts, and any extraordinary items that may impact this year's results. This excludes investment income or one-time asset sales.">
                                    </lightning-helptext>
                                </label>
                                <lightning-radio-group 
                                    name="operationalLoss"
                                    options={yesNoOptions}
                                    value={formData.operationalLoss}
                                    onchange={handleInputChange}
                                    type="button"
                                    required="true">
                                </lightning-radio-group>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Provider Contact Information -->
        <div if:true={isPage2} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Provider Contact Information</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Account Information -->
                    <div class="slds-section slds-m-bottom_large">
                        <h3 class="slds-section__title">Account Information</h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <div class="slds-grid slds-gutters">
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-formatted-text 
                                        value={accountInfo.name}
                                        class="account-name">
                                    </lightning-formatted-text>
                                </div>
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-formatted-text 
                                        value={accountInfo.napsId}
                                        class="naps-id">
                                    </lightning-formatted-text>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Primary Contact -->
                    <div class="slds-section">
                        <div class="slds-section__title-action-bar">
                            <h3 class="slds-section__title">Primary Contact</h3>
                            <lightning-button 
                                label={editButtonLabel}
                                variant={editButtonVariant}
                                onclick={handleEditContact}
                                class="edit-contact-btn">
                            </lightning-button>
                        </div>
                        <div class="slds-section__content slds-p-around_medium">
                            <div if:false={isEditingContact} class="contact-display">
                                <div class="slds-grid slds-gutters slds-wrap">
                                    <div class="slds-col slds-size_1-of-2">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Name</label>
                                            <div class="slds-form-element__static">
                                                {contactInfo.name}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Position</label>
                                            <div class="slds-form-element__static">
                                                {contactInfo.position}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Phone</label>
                                            <div class="slds-form-element__static">
                                                {contactInfo.phone}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Email</label>
                                            <div class="slds-form-element__static">
                                                {contactInfo.email}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div if:true={isEditingContact} class="contact-edit">
                                <div class="slds-grid slds-gutters slds-wrap">
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input 
                                            label="Name"
                                            name="contactName"
                                            value={contactInfo.name}
                                            onchange={handleContactChange}
                                            required="true">
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input 
                                            label="Position"
                                            name="contactPosition"
                                            value={contactInfo.position}
                                            onchange={handleContactChange}
                                            required="true">
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input 
                                            label="Phone"
                                            name="contactPhone"
                                            type="tel"
                                            value={contactInfo.phone}
                                            onchange={handleContactChange}
                                            required="true">
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input 
                                            label="Email"
                                            name="contactEmail"
                                            type="email"
                                            value={contactInfo.email}
                                            onchange={handleContactChange}
                                            required="true">
                                        </lightning-input>
                                    </div>
                                </div>
                                <div class="slds-m-top_medium">
                                    <lightning-button 
                                        label="Save"
                                        variant="brand"
                                        onclick={handleSaveContact}
                                        class="slds-m-right_small">
                                    </lightning-button>
                                    <lightning-button 
                                        label="Cancel"
                                        variant="neutral"
                                        onclick={handleCancelEdit}>
                                    </lightning-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Business Structure Configuration -->
        <div if:true={isPage3} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Business Structure Configuration</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Business Structure Selection -->
                    <div class="slds-section slds-m-bottom_large">
                        <h3 class="slds-section__title">Business Structure Types</h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <template for:each={businessStructureTypes} for:item="structureType">
                                <div key={structureType.name} class="structure-type-container slds-m-bottom_medium">
                                    <div class="slds-form-element">
                                        <label class="slds-form-element__label toggle-label">
                                            {structureType.label}
                                        </label>
                                        <lightning-input 
                                            type="toggle"
                                            name={structureType.name}
                                            checked={structureType.selected}
                                            onchange={handleStructureToggle}
                                            message-toggle-active="Yes"
                                            message-toggle-inactive="No">
                                        </lightning-input>
                                    </div>
                                    
                                    <div if:true={structureType.selected} class="conditional-content slds-m-top_small slds-p-left_large">
                                        <lightning-checkbox-group 
                                            label="Service Types"
                                            options={serviceTypeOptions}
                                            value={structureType.serviceTypes}
                                            onchange={handleServiceTypeChange}
                                            data-structure={structureType.name}>
                                        </lightning-checkbox-group>
                                        
                                        <div class="slds-m-top_small">
                                            <lightning-textarea 
                                                label="Additional Information"
                                                placeholder="Please provide percentage breakdowns and explanations..."
                                                value={structureType.additionalInfo}
                                                onchange={handleAdditionalInfoChange}
                                                data-structure={structureType.name}>
                                            </lightning-textarea>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Workforce Configuration -->
                    <div class="slds-section">
                        <h3 class="slds-section__title">Workforce Configuration</h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <lightning-combobox 
                                label="Workforce Engagement Method"
                                name="workforceType"
                                value={formData.workforceType}
                                placeholder="Select workforce type..."
                                options={workforceOptions}
                                onchange={handleInputChange}
                                required="true">
                            </lightning-combobox>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Labour Costs Data Management -->
        <div if:true={isPage4} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Labour Costs Data Management</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-section">
                        <h3 class="slds-section__title">Internal Direct Care Labour Costs</h3>
                        <div class="slds-section__content">
                            <lightning-datatable 
                                key-field="id"
                                data={labourCostData}
                                columns={labourCostColumns}
                                oncellchange={handleCellChange}
                                draft-values={draftValues}
                                hide-checkbox-column="true"
                                show-row-number-column="false">
                            </lightning-datatable>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 5: Document Management and Submission -->
        <div if:true={isPage5} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Document Management and Submission</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Document Upload Configuration -->
                    <div class="slds-section slds-m-bottom_large">
                        <h3 class="slds-section__title">Document Upload</h3>
                        <div class="slds-section__content slds-p-around_medium">
                            <div class="slds-grid slds-gutters slds-wrap">
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-combobox 
                                        label="Document Category"
                                        name="documentCategory"
                                        value={selectedDocumentCategory}
                                        placeholder="Select category..."
                                        options={documentCategoryOptions}
                                        onchange={handleDocumentCategoryChange}
                                        required="true">
                                    </lightning-combobox>
                                </div>
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-combobox 
                                        label="Document Type"
                                        name="documentType"
                                        value={selectedDocumentType}
                                        placeholder="Select type..."
                                        options={documentTypeOptions}
                                        onchange={handleDocumentTypeChange}
                                        required="true">
                                    </lightning-combobox>
                                </div>
                            </div>
                            
                            <!-- File Upload Interface -->
                            <div class="slds-m-top_medium">
                                <div class="file-upload-container">
                                    <div class="slds-file-selector slds-file-selector_files">
                                        <div class="slds-file-selector__dropzone">
                                            <input 
                                                type="file" 
                                                class="slds-file-selector__input slds-assistive-text" 
                                                accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png" 
                                                id="file-upload-input" 
                                                onchange={handleFileUpload}
                                                multiple />
                                            <label class="slds-file-selector__body" for="file-upload-input">
                                                <span class="slds-file-selector__button slds-button slds-button_neutral">
                                                    <lightning-icon icon-name="utility:upload" size="x-small"></lightning-icon>
                                                    Upload Files
                                                </span>
                                                <span class="slds-file-selector__text slds-medium-show">or drop files</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Management Table -->
                    <div class="slds-section">
                        <h3 class="slds-section__title">Uploaded Documents</h3>
                        <div class="slds-section__content">
                            <lightning-datatable 
                                key-field="id"
                                data={uploadedDocuments}
                                columns={documentColumns}
                                onrowaction={handleDocumentAction}
                                hide-checkbox-column="true">
                            </lightning-datatable>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Controls -->
        <div class="navigation-controls slds-m-top_large">
            <div class="slds-grid slds-grid_align-spread">
                <div class="slds-col">
                    <lightning-button 
                        label="Previous"
                        variant="neutral"
                        onclick={handlePrevious}
                        disabled={isPreviousDisabled}
                        icon-name="utility:chevronleft"
                        icon-position="left">
                    </lightning-button>
                </div>
                <div class="slds-col">
                    <lightning-button 
                        label={nextButtonLabel}
                        variant="brand"
                        onclick={handleNext}
                        disabled={isNextDisabled}
                        icon-name={nextButtonIcon}
                        icon-position="right">
                    </lightning-button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div if:true={isLoading} class="slds-spinner_container">
            <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
        </div>

        <!-- Error Messages -->
        <div if:true={hasErrors} class="slds-m-top_medium">
            <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
                <span class="slds-assistive-text">Error</span>
                <lightning-icon icon-name="utility:error" size="x-small" variant="inverse"></lightning-icon>
                <h2>Please correct the following errors:</h2>
                <ul>
                    <template for:each={errorMessages} for:item="error">
                        <li key={error.id}>{error.message}</li>
                    </template>
                </ul>
            </div>
        </div>
    </div>
</template>
