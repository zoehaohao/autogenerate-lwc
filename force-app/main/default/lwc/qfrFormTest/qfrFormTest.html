<template>
    <div class="qfr-form-container">
        <!-- Progress Indicator -->
        <lightning-progress-indicator 
            current-step={currentStep} 
            type="path" 
            variant="base">
            <lightning-progress-step 
                label="Residential Viability" 
                value="1">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Contact Information" 
                value="2">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Business Structure" 
                value="3">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Labour Costs" 
                value="4">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Document Upload" 
                value="5">
            </lightning-progress-step>
        </lightning-progress-indicator>

        <!-- Page 1: Residential Viability and Prudential Reporting -->
        <div if:true={isPage1} class="page-content">
            <h2 class="page-title">Residential Viability and Prudential Reporting</h2>
            
            <!-- About this section accordion -->
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}
                class="info-accordion">
                <lightning-accordion-section name="about-section" label="About this section">
                    <div class="info-content">
                        <p>This section collects information about the financial health and viability of residential care services to identify providers who may need additional support or intervention. Your responses help us understand your organization's current financial position and any potential concerns that may require attention.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <!-- Solvency Section -->
            <div class="slds-card slds-m-bottom_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title">Solvency</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label">
                            <span class="required-asterisk">*</span>
                            Are you currently concerned about the solvency of your organisation?
                        </label>
                        <lightning-radio-group 
                            name="solvencyConcern"
                            options={yesNoOptions}
                            value={formData.solvencyConcern}
                            onchange={handleSolvencyChange}
                            type="button"
                            class="radio-button-group">
                        </lightning-radio-group>
                    </div>
                    
                    <div class="slds-form-element">
                        <label class="slds-form-element__label">
                            <span class="required-asterisk">*</span>
                            Do you envisage any solvency issues arising in the next six months?
                        </label>
                        <lightning-radio-group 
                            name="futureSolvency"
                            options={yesNoOptions}
                            value={formData.futureSolvency}
                            onchange={handleFutureSolvencyChange}
                            type="button"
                            class="radio-button-group">
                        </lightning-radio-group>
                    </div>
                </div>
            </div>

            <!-- Financial Performance Section -->
            <div class="slds-card">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title">Financial Performance</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-form-element">
                        <label class="slds-form-element__label">
                            <span class="required-asterisk">*</span>
                            Do you forecast an operational loss for the current year?
                            <lightning-helptext 
                                content="An operational loss occurs when operating expenses exceed operating revenues from your core care services. Consider your year-to-date performance, budget forecasts, and any extraordinary items that may impact this year's results. This excludes investment income or one-time asset sales.">
                            </lightning-helptext>
                        </label>
                        <lightning-radio-group 
                            name="operationalLoss"
                            options={yesNoOptions}
                            value={formData.operationalLoss}
                            onchange={handleOperationalLossChange}
                            type="button"
                            class="radio-button-group">
                        </lightning-radio-group>
                    </div>
                </div>
            </div>

            <!-- Validation Error Messages -->
            <div if:true={showPage1Errors} class="slds-notify slds-notify_alert slds-theme_error slds-m-top_medium">
                <span class="slds-assistive-text">Error</span>
                <h2>Please complete all required fields before proceeding.</h2>
            </div>
        </div>

        <!-- Page 2: Provider Contact Information -->
        <div if:true={isPage2} class="page-content">
            <h2 class="page-title">Provider Contact Information</h2>
            
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}
                class="info-accordion">
                <lightning-accordion-section name="contact-info" label="About this section">
                    <div class="info-content">
                        <p>Please ensure we have current, accurate contact information for the primary person responsible for the QFR submission and any follow-up communications.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <div class="slds-card">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title">Account Information</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-grid slds-gutters">
                        <div class="slds-col slds-size_1-of-2">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">Organisation Name</label>
                                <div class="slds-form-element__control">
                                    <span class="slds-form-element__static">{contactInfo.organizationName}</span>
                                </div>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">NAPS ID</label>
                                <div class="slds-form-element__control">
                                    <span class="slds-form-element__static">{contactInfo.napsId}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <h3 class="slds-card__header-title slds-grow">Primary Contact</h3>
                    <lightning-button 
                        label={editButtonLabel}
                        variant={editButtonVariant}
                        onclick={handleEditContact}
                        class="edit-button">
                    </lightning-button>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div if:false={isEditingContact} class="contact-display">
                        <div class="slds-grid slds-gutters slds-m-bottom_small">
                            <div class="slds-col slds-size_1-of-2">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Name</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-form-element__static">{contactInfo.name}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Position</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-form-element__static">{contactInfo.position}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="slds-grid slds-gutters">
                            <div class="slds-col slds-size_1-of-2">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Phone</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-form-element__static">{contactInfo.phone}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Email</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-form-element__static">{contactInfo.email}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div if:true={isEditingContact} class="contact-edit">
                        <div class="slds-grid slds-gutters slds-m-bottom_small">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="Name"
                                    value={editContactInfo.name}
                                    onchange={handleContactNameChange}
                                    required="true">
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="Position"
                                    value={editContactInfo.position}
                                    onchange={handleContactPositionChange}
                                    required="true">
                                </lightning-input>
                            </div>
                        </div>
                        <div class="slds-grid slds-gutters">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="Phone"
                                    type="tel"
                                    value={editContactInfo.phone}
                                    onchange={handleContactPhoneChange}
                                    required="true">
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="Email"
                                    type="email"
                                    value={editContactInfo.email}
                                    onchange={handleContactEmailChange}
                                    required="true">
                                </lightning-input>
                            </div>
                        </div>
                        <div class="slds-m-top_medium">
                            <lightning-button 
                                label="Save"
                                variant="brand"
                                onclick={handleSaveContact}
                                class="slds-m-right_small">
                            </lightning-button>
                            <lightning-button 
                                label="Cancel"
                                variant="neutral"
                                onclick={handleCancelEdit}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Business Structure Configuration -->
        <div if:true={isPage3} class="page-content">
            <h2 class="page-title">Business Structure Configuration</h2>
            
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}
                class="info-accordion">
                <lightning-accordion-section name="business-structure" label="About this section">
                    <div class="info-content">
                        <p>Help us understand how you organize your service delivery to ensure appropriate regulatory oversight and support. You can select multiple business structures that apply to your organization.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <div class="slds-card">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title">Business Structure</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- In-house delivery -->
                    <div class="business-structure-item">
                        <div class="slds-grid slds-grid_align-spread">
                            <div class="slds-col">
                                <label class="slds-form-element__label">In-house delivery</label>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <lightning-input 
                                    type="toggle"
                                    checked={businessStructure.inHouse}
                                    onchange={handleInHouseChange}>
                                </lightning-input>
                            </div>
                        </div>
                        <div if:true={businessStructure.inHouse} class="conditional-content">
                            <lightning-checkbox-group 
                                label="Service Types"
                                options={serviceTypeOptions}
                                value={businessStructure.inHouseServices}
                                onchange={handleInHouseServicesChange}>
                            </lightning-checkbox-group>
                        </div>
                    </div>

                    <!-- Franchisee -->
                    <div class="business-structure-item">
                        <div class="slds-grid slds-grid_align-spread">
                            <div class="slds-col">
                                <label class="slds-form-element__label">Franchisee</label>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <lightning-input 
                                    type="toggle"
                                    checked={businessStructure.franchisee}
                                    onchange={handleFranchiseeChange}>
                                </lightning-input>
                            </div>
                        </div>
                        <div if:true={businessStructure.franchisee} class="conditional-content">
                            <lightning-checkbox-group 
                                label="Service Types"
                                options={serviceTypeOptions}
                                value={businessStructure.franchiseeServices}
                                onchange={handleFranchiseeServicesChange}>
                            </lightning-checkbox-group>
                        </div>
                    </div>

                    <!-- Franchisor -->
                    <div class="business-structure-item">
                        <div class="slds-grid slds-grid_align-spread">
                            <div class="slds-col">
                                <label class="slds-form-element__label">Franchisor</label>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <lightning-input 
                                    type="toggle"
                                    checked={businessStructure.franchisor}
                                    onchange={handleFranchisorChange}>
                                </lightning-input>
                            </div>
                        </div>
                        <div if:true={businessStructure.franchisor} class="conditional-content">
                            <lightning-checkbox-group 
                                label="Service Types"
                                options={serviceTypeOptions}
                                value={businessStructure.franchisorServices}
                                onchange={handleFranchisorServicesChange}>
                            </lightning-checkbox-group>
                        </div>
                    </div>

                    <!-- Brokerage -->
                    <div class="business-structure-item">
                        <div class="slds-grid slds-grid_align-spread">
                            <div class="slds-col">
                                <label class="slds-form-element__label">Brokerage</label>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <lightning-input 
                                    type="toggle"
                                    checked={businessStructure.brokerage}
                                    onchange={handleBrokerageChange}>
                                </lightning-input>
                            </div>
                        </div>
                        <div if:true={businessStructure.brokerage} class="conditional-content">
                            <lightning-checkbox-group 
                                label="Service Types"
                                options={serviceTypeOptions}
                                value={businessStructure.brokerageServices}
                                onchange={handleBrokerageServicesChange}>
                            </lightning-checkbox-group>
                        </div>
                    </div>

                    <!-- Subcontractor -->
                    <div class="business-structure-item">
                        <div class="slds-grid slds-grid_align-spread">
                            <div class="slds-col">
                                <label class="slds-form-element__label">Subcontractor</label>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <lightning-input 
                                    type="toggle"
                                    checked={businessStructure.subcontractor}
                                    onchange={handleSubcontractorChange}>
                                </lightning-input>
                            </div>
                        </div>
                        <div if:true={businessStructure.subcontractor} class="conditional-content">
                            <lightning-checkbox-group 
                                label="Service Types"
                                options={serviceTypeOptions}
                                value={businessStructure.subcontractorServices}
                                onchange={handleSubcontractorServicesChange}>
                            </lightning-checkbox-group>
                        </div>
                    </div>

                    <!-- Self-employ individual -->
                    <div class="business-structure-item">
                        <div class="slds-grid slds-grid_align-spread">
                            <div class="slds-col">
                                <label class="slds-form-element__label">Self-employ individual</label>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <lightning-input 
                                    type="toggle"
                                    checked={businessStructure.selfEmployed}
                                    onchange={handleSelfEmployedChange}>
                                </lightning-input>
                            </div>
                        </div>
                        <div if:true={businessStructure.selfEmployed} class="conditional-content">
                            <lightning-checkbox-group 
                                label="Service Types"
                                options={serviceTypeOptions}
                                value={businessStructure.selfEmployedServices}
                                onchange={handleSelfEmployedServicesChange}>
                            </lightning-checkbox-group>
                        </div>
                    </div>

                    <!-- Other -->
                    <div class="business-structure-item">
                        <div class="slds-grid slds-grid_align-spread">
                            <div class="slds-col">
                                <label class="slds-form-element__label">Other</label>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <lightning-input 
                                    type="toggle"
                                    checked={businessStructure.other}
                                    onchange={handleOtherChange}>
                                </lightning-input>
                            </div>
                        </div>
                        <div if:true={businessStructure.other} class="conditional-content">
                            <lightning-checkbox-group 
                                label="Service Types"
                                options={serviceTypeOptions}
                                value={businessStructure.otherServices}
                                onchange={handleOtherServicesChange}>
                            </lightning-checkbox-group>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workforce Section -->
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title">Workforce</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <lightning-combobox 
                        label="How are your direct care workers engaged?"
                        value={businessStructure.workforceType}
                        options={workforceOptions}
                        onchange={handleWorkforceChange}
                        required="true">
                    </lightning-combobox>
                </div>
            </div>

            <!-- QA Assessor Comments -->
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title">QA Assessor Comments</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-form-element__static qa-comments">
                        No comments available
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Labour Costs Data Management -->
        <div if:true={isPage4} class="page-content">
            <h2 class="page-title">Labour Costs Data Management</h2>
            
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}
                class="info-accordion">
                <lightning-accordion-section name="labour-costs" label="About this section">
                    <div class="info-content">
                        <p>Capture detailed breakdown of internal direct care labour costs to assess provider workforce composition and cost structures for regulatory oversight and benchmarking.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <div class="slds-card">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title">Internal Direct Care Labour Costs</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <lightning-datatable 
                        key-field="id"
                        data={labourCostsData}
                        columns={labourCostsColumns}
                        oncellchange={handleLabourCostsChange}
                        hide-checkbox-column="true"
                        show-row-number-column="false">
                    </lightning-datatable>
                </div>
            </div>
        </div>

        <!-- Page 5: Document Management and Submission -->
        <div if:true={isPage5} class="page-content">
            <h2 class="page-title">Document Management and Submission</h2>
            
            <lightning-accordion 
                active-section-name={openSections} 
                allow-multiple-sections-open="true"
                onselect={handleAccordionToggle}
                class="info-accordion">
                <lightning-accordion-section name="documents" label="About this section">
                    <div class="info-content">
                        <p>Upload required supporting documentation to complete your QFR submission. All documents will be reviewed as part of the assessment process.</p>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>

            <div class="slds-card">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title">Document Upload</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="upload-section">
                        <div class="slds-grid slds-gutters slds-m-bottom_medium">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-combobox 
                                    label="Document Category"
                                    value={uploadConfig.category}
                                    options={documentCategories}
                                    onchange={handleCategoryChange}
                                    required="true">
                                </lightning-combobox>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-combobox 
                                    label="Document Type"
                                    value={uploadConfig.type}
                                    options={documentTypes}
                                    onchange={handleTypeChange}
                                    required="true">
                                </lightning-combobox>
                            </div>
                        </div>
                        
                        <div class="file-upload-area" ondrop={handleFileDrop} ondragover={handleDragOver}>
                            <div class="upload-content">
                                <lightning-icon icon-name="utility:upload" size="large" class="upload-icon"></lightning-icon>
                                <p class="upload-text">Drag and drop files here or</p>
                                <lightning-button 
                                    label="Browse Files"
                                    variant="brand"
                                    onclick={handleBrowseFiles}>
                                </lightning-button>
                                <p class="upload-help">Supported formats: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG</p>
                            </div>
                            <input type="file" class="file-input" onchange={handleFileSelect} multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Uploaded Documents -->
            <div if:true={hasUploadedFiles} class="slds-card slds-m-top_medium">
                <div class="slds-card__header">
                    <h3 class="slds-card__header-title">Uploaded Documents</h3>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <lightning-datatable 
                        key-field="id"
                        data={uploadedFiles}
                        columns={fileColumns}
                        onrowaction={handleFileAction}
                        hide-checkbox-column="true">
                    </lightning-datatable>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
            <lightning-button 
                label="Previous"
                variant="neutral"
                onclick={handlePrevious}
                disabled={isPreviousDisabled}
                class="nav-button">
            </lightning-button>
            
            <lightning-button 
                label={nextButtonLabel}
                variant="brand"
                onclick={handleNext}
                disabled={isNextDisabled}
                class="nav-button">
            </lightning-button>
        </div>

        <!-- Loading Spinner -->
        <div if:true={isLoading} class="loading-overlay">
            <lightning-spinner alternative-text="Loading..." size="large"></lightning-spinner>
        </div>
    </div>
</template>
