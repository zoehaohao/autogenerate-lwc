<template>
    <div class="qfr-form-container">
        <div class="form-header">
            <h2 class="form-title">Quarterly Financial Review Form</h2>
            <p class="form-description">Please complete all required fields to submit your quarterly financial review.</p>
        </div>

        <lightning-accordion 
            active-section-name={openSections} 
            allow-multiple-sections-open="true"
            onselect={handleAccordionToggle}
            class="qfr-accordion">
            
            <!-- Organization Information Section -->
            <lightning-accordion-section name="orgInfo" label="Organization Information">
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-field">
                            <lightning-input
                                label="Organization Name *"
                                value={organizationName}
                                onchange={handleInputChange}
                                data-field="organizationName"
                                required="true"
                                placeholder="Enter organization name">
                            </lightning-input>
                        </div>
                        <div class="form-field">
                            <lightning-input
                                label="Registration Number *"
                                value={registrationNumber}
                                onchange={handleInputChange}
                                data-field="registrationNumber"
                                required="true"
                                placeholder="Enter registration number">
                            </lightning-input>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <lightning-combobox
                                label="Organization Type *"
                                value={organizationType}
                                placeholder="Select organization type"
                                options={organizationTypeOptions}
                                onchange={handleInputChange}
                                data-field="organizationType"
                                required="true">
                            </lightning-combobox>
                        </div>
                        <div class="form-field">
                            <lightning-input
                                type="date"
                                label="Financial Year End *"
                                value={financialYearEnd}
                                onchange={handleInputChange}
                                data-field="financialYearEnd"
                                required="true">
                            </lightning-input>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field full-width">
                            <lightning-textarea
                                label="Business Address *"
                                value={businessAddress}
                                onchange={handleInputChange}
                                data-field="businessAddress"
                                required="true"
                                placeholder="Enter complete business address">
                            </lightning-textarea>
                        </div>
                    </div>
                </div>
            </lightning-accordion-section>

            <!-- Contact Information Section -->
            <lightning-accordion-section name="contactInfo" label="Contact Information">
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-field">
                            <lightning-input
                                label="Primary Contact Name *"
                                value={primaryContactName}
                                onchange={handleInputChange}
                                data-field="primaryContactName"
                                required="true"
                                placeholder="Enter contact name">
                            </lightning-input>
                        </div>
                        <div class="form-field">
                            <lightning-input
                                label="Job Title *"
                                value={jobTitle}
                                onchange={handleInputChange}
                                data-field="jobTitle"
                                required="true"
                                placeholder="Enter job title">
                            </lightning-input>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <lightning-input
                                type="email"
                                label="Email Address *"
                                value={emailAddress}
                                onchange={handleInputChange}
                                data-field="emailAddress"
                                required="true"
                                placeholder="Enter email address">
                            </lightning-input>
                        </div>
                        <div class="form-field">
                            <lightning-input
                                type="tel"
                                label="Phone Number *"
                                value={phoneNumber}
                                onchange={handleInputChange}
                                data-field="phoneNumber"
                                required="true"
                                placeholder="Enter phone number">
                            </lightning-input>
                        </div>
                    </div>
                </div>
            </lightning-accordion-section>

            <!-- Financial Information Section -->
            <lightning-accordion-section name="financialInfo" label="Financial Information">
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-field">
                            <lightning-input
                                type="number"
                                label="Total Revenue (Current Quarter) *"
                                value={totalRevenue}
                                onchange={handleInputChange}
                                data-field="totalRevenue"
                                required="true"
                                formatter="currency"
                                placeholder="0.00">
                            </lightning-input>
                        </div>
                        <div class="form-field">
                            <lightning-input
                                type="number"
                                label="Total Expenses (Current Quarter) *"
                                value={totalExpenses}
                                onchange={handleInputChange}
                                data-field="totalExpenses"
                                required="true"
                                formatter="currency"
                                placeholder="0.00">
                            </lightning-input>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <lightning-input
                                type="number"
                                label="Net Profit/Loss *"
                                value={netProfitLoss}
                                onchange={handleInputChange}
                                data-field="netProfitLoss"
                                required="true"
                                formatter="currency"
                                placeholder="0.00"
                                readonly="true">
                            </lightning-input>
                        </div>
                        <div class="form-field">
                            <lightning-input
                                type="number"
                                label="Cash Flow *"
                                value={cashFlow}
                                onchange={handleInputChange}
                                data-field="cashFlow"
                                required="true"
                                formatter="currency"
                                placeholder="0.00">
                            </lightning-input>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <div class="question-with-tooltip">
                                <span class="question-label">Are you currently concerned about the solvency of your organisation? *</span>
                                <lightning-helptext
                                    content="Solvency refers to your organisation's ability to meet its long-term financial obligations."
                                    icon-name="utility:info"
                                    icon-variant="inverse">
                                </lightning-helptext>
                            </div>
                            <lightning-radio-group
                                options={solvencyOptions}
                                value={solvencyConcern}
                                onchange={handleInputChange}
                                data-field="solvencyConcern"
                                type="radio"
                                required="true">
                            </lightning-radio-group>
                        </div>
                    </div>

                    <template if:true={showSolvencyDetails}>
                        <div class="form-row">
                            <div class="form-field full-width">
                                <lightning-textarea
                                    label="Please provide details about your solvency concerns *"
                                    value={solvencyDetails}
                                    onchange={handleInputChange}
                                    data-field="solvencyDetails"
                                    required="true"
                                    placeholder="Describe your concerns in detail">
                                </lightning-textarea>
                            </div>
                        </div>
                    </template>
                </div>
            </lightning-accordion-section>

            <!-- Risk Assessment Section -->
            <lightning-accordion-section name="riskAssessment" label="Risk Assessment">
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-field">
                            <lightning-combobox
                                label="Overall Risk Level *"
                                value={overallRiskLevel}
                                placeholder="Select risk level"
                                options={riskLevelOptions}
                                onchange={handleInputChange}
                                data-field="overallRiskLevel"
                                required="true">
                            </lightning-combobox>
                        </div>
                        <div class="form-field">
                            <lightning-checkbox-group
                                label="Risk Factors (Select all that apply) *"
                                options={riskFactorOptions}
                                value={selectedRiskFactors}
                                onchange={handleRiskFactorChange}
                                required="true">
                            </lightning-checkbox-group>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field full-width">
                            <lightning-textarea
                                label="Risk Mitigation Strategies *"
                                value={riskMitigationStrategies}
                                onchange={handleInputChange}
                                data-field="riskMitigationStrategies"
                                required="true"
                                placeholder="Describe your risk mitigation strategies">
                            </lightning-textarea>
                        </div>
                    </div>
                </div>
            </lightning-accordion-section>

            <!-- Financial Data Table Section -->
            <lightning-accordion-section name="financialData" label="Quarterly Financial Data">
                <div class="section-content">
                    <div class="datatable-container">
                        <lightning-datatable
                            key-field="id"
                            data={financialData}
                            columns={financialColumns}
                            oncellchange={handleCellChange}
                            draft-values={draftValues}
                            hide-checkbox-column="true">
                        </lightning-datatable>
                    </div>
                    
                    <div class="datatable-actions">
                        <lightning-button
                            label="Save Changes"
                            variant="brand"
                            onclick={handleSaveTableData}
                            disabled={isProcessing}>
                        </lightning-button>
                        <lightning-button
                            label="Cancel Changes"
                            variant="neutral"
                            onclick={handleCancelTableChanges}
                            disabled={isProcessing}>
                        </lightning-button>
                    </div>
                </div>
            </lightning-accordion-section>
        </lightning-accordion>

        <!-- Form Actions -->
        <div class="form-actions">
            <lightning-button
                label="Save Draft"
                variant="neutral"
                onclick={handleSaveDraft}
                disabled={isProcessing}
                class="action-button">
            </lightning-button>
            
            <lightning-button
                label="Submit Form"
                variant="brand"
                onclick={handleSubmitForm}
                disabled={submitDisabled}
                class="action-button">
            </lightning-button>
        </div>

        <!-- Loading Spinner -->
        <template if:true={isProcessing}>
            <lightning-spinner
                alternative-text="Processing..."
                size="medium">
            </lightning-spinner>
        </template>

        <!-- Success/Error Messages -->
        <template if:true={showSuccessMessage}>
            <div class="success-message">
                <lightning-icon icon-name="utility:success" size="small"></lightning-icon>
                <span>{successMessage}</span>
            </div>
        </template>

        <template if:true={showErrorMessage}>
            <div class="error-message">
                <lightning-icon icon-name="utility:error" size="small"></lightning-icon>
                <span>{errorMessage}</span>
            </div>
        </template>
    </div>
</template>
