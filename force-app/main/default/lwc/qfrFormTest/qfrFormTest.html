<template>
    <div class="qfr-form-container">
        <!-- Progress Indicator -->
        <lightning-progress-indicator 
            current-step={currentStep} 
            type="path" 
            variant="base">
            <lightning-progress-step 
                label="Residential Viability" 
                value="1">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Contact Information" 
                value="2">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Business Structure" 
                value="3">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Labour Costs" 
                value="4">
            </lightning-progress-step>
            <lightning-progress-step 
                label="Document Management" 
                value="5">
            </lightning-progress-step>
        </lightning-progress-indicator>

        <!-- Page 1: Residential Viability and Prudential Reporting -->
        <div if:true={isPage1} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">Residential Viability and Prudential Reporting</h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Information Section -->
                    <lightning-accordion 
                        active-section-name={openSections} 
                        allow-multiple-sections-open="true"
                        onselect={handleAccordionToggle}>
                        <lightning-accordion-section name="about" label="About this section">
                            <div class="slds-p-horizontal_medium">
                                <p>This section collects information about your organization's financial health and viability to identify providers who may need additional support or intervention. Your responses help us understand your current financial position and any concerns you may have about future sustainability.</p>
                            </div>
                        </lightning-accordion-section>
                    </lightning-accordion>

                    <!-- Solvency Assessment -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title">Solvency Assessment</h3>
                        <div class="slds-form-element slds-m-bottom_medium">
                            <label class="slds-form-element__label">
                                <span class="required-asterisk">*</span>
                                Are you currently concerned about the solvency of your organisation?
                            </label>
                            <lightning-helptext content="Solvency refers to your organization's ability to meet long-term debts and financial obligations. Consider your current cash flow, debt levels, and ability to pay creditors."></lightning-helptext>
                            <lightning-radio-group 
                                name="solvencyConcern"
                                options={yesNoOptions}
                                value={formData.solvencyConcern}
                                onchange={handleInputChange}
                                type="button"
                                required="true">
                            </lightning-radio-group>
                        </div>

                        <div class="slds-form-element slds-m-bottom_medium">
                            <label class="slds-form-element__label">
                                <span class="required-asterisk">*</span>
                                Do you envisage any solvency issues arising in the next six months?
                            </label>
                            <lightning-helptext content="Consider your projected cash flow, upcoming debt obligations, seasonal variations in revenue, and any known changes to your business environment."></lightning-helptext>
                            <lightning-radio-group 
                                name="futureSolvencyIssues"
                                options={yesNoOptions}
                                value={formData.futureSolvencyIssues}
                                onchange={handleInputChange}
                                type="button"
                                required="true">
                            </lightning-radio-group>
                        </div>
                    </div>

                    <!-- Financial Performance Assessment -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title">Financial Performance Assessment</h3>
                        <div class="slds-form-element slds-m-bottom_medium">
                            <label class="slds-form-element__label">
                                <span class="required-asterisk">*</span>
                                Do you forecast an operational loss for the current year?
                            </label>
                            <lightning-helptext content="An operational loss occurs when operating expenses exceed operating revenues from your core care services. Consider your year-to-date performance, budget forecasts, and any extraordinary items that may impact this year's results. This excludes investment income or one-time asset sales."></lightning-helptext>
                            <lightning-radio-group 
                                name="operationalLoss"
                                options={yesNoOptions}
                                value={formData.operationalLoss}
                                onchange={handleInputChange}
                                type="button"
                                required="true">
                            </lightning-radio-group>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Provider Contact Information -->
        <div if:true={isPage2} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">Provider Contact Information</h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Information Section -->
                    <lightning-accordion 
                        active-section-name={openSections} 
                        allow-multiple-sections-open="true"
                        onselect={handleAccordionToggle}>
                        <lightning-accordion-section name="contactInfo" label="About contact requirements">
                            <div class="slds-p-horizontal_medium">
                                <p>Please ensure we have current, accurate contact information for the primary person responsible for this QFR submission and any follow-up communications. This person should be authorized to discuss financial matters on behalf of your organization.</p>
                            </div>
                        </lightning-accordion-section>
                    </lightning-accordion>

                    <!-- Account Information -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title">Account Information</h3>
                        <div class="slds-grid slds-gutters">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="Organization Name" 
                                    value={formData.organizationName}
                                    name="organizationName"
                                    onchange={handleInputChange}
                                    readonly={contactReadOnly}
                                    required="true">
                                    <lightning-helptext slot="help" content="The legal name of your organization as registered with regulatory authorities."></lightning-helptext>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="NAPS ID" 
                                    value={formData.napsId}
                                    name="napsId"
                                    onchange={handleInputChange}
                                    readonly={contactReadOnly}
                                    required="true">
                                    <lightning-helptext slot="help" content="Your National Aged Care Provider System identification number."></lightning-helptext>
                                </lightning-input>
                            </div>
                        </div>
                    </div>

                    <!-- Primary Contact -->
                    <div class="slds-section slds-m-top_large">
                        <div class="slds-section__title-container">
                            <h3 class="slds-section__title">Primary Contact</h3>
                            <lightning-button 
                                label={editButtonLabel}
                                variant={editButtonVariant}
                                onclick={handleEditContact}
                                class="slds-float_right">
                            </lightning-button>
                        </div>
                        
                        <div class="slds-grid slds-gutters slds-m-top_medium">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="Contact Name" 
                                    value={formData.contactName}
                                    name="contactName"
                                    onchange={handleInputChange}
                                    readonly={contactReadOnly}
                                    required="true">
                                    <lightning-helptext slot="help" content="Full name of the primary contact person for QFR matters."></lightning-helptext>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="Position/Title" 
                                    value={formData.contactPosition}
                                    name="contactPosition"
                                    onchange={handleInputChange}
                                    readonly={contactReadOnly}
                                    required="true">
                                    <lightning-helptext slot="help" content="Job title or position of the contact person within your organization."></lightning-helptext>
                                </lightning-input>
                            </div>
                        </div>
                        
                        <div class="slds-grid slds-gutters slds-m-top_medium">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="Phone Number" 
                                    value={formData.contactPhone}
                                    name="contactPhone"
                                    type="tel"
                                    onchange={handleInputChange}
                                    readonly={contactReadOnly}
                                    required="true">
                                    <lightning-helptext slot="help" content="Primary phone number where this contact can be reached during business hours."></lightning-helptext>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input 
                                    label="Email Address" 
                                    value={formData.contactEmail}
                                    name="contactEmail"
                                    type="email"
                                    onchange={handleInputChange}
                                    readonly={contactReadOnly}
                                    required="true">
                                    <lightning-helptext slot="help" content="Primary email address for QFR correspondence and follow-up communications."></lightning-helptext>
                                </lightning-input>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Business Structure Configuration -->
        <div if:true={isPage3} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">Business Structure Configuration</h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Information Section -->
                    <lightning-accordion 
                        active-section-name={openSections} 
                        allow-multiple-sections-open="true"
                        onselect={handleAccordionToggle}>
                        <lightning-accordion-section name="businessStructure" label="About business structure classification">
                            <div class="slds-p-horizontal_medium">
                                <p>Help us understand how your organization structures its service delivery. This information ensures appropriate regulatory oversight and support. You may select multiple structures if your organization operates under different models.</p>
                            </div>
                        </lightning-accordion-section>
                    </lightning-accordion>

                    <!-- Business Structure Types -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title">Business Structure Types</h3>
                        
                        <!-- In-house delivery -->
                        <div class="business-structure-item">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label toggle-label">
                                    In-house delivery
                                    <lightning-helptext content="Services delivered directly by your employed staff using your organization's resources and facilities."></lightning-helptext>
                                </label>
                                <lightning-input 
                                    type="toggle"
                                    name="inhouseDelivery"
                                    checked={formData.inhouseDelivery}
                                    onchange={handleToggleChange}>
                                </lightning-input>
                            </div>
                            <div if:true={formData.inhouseDelivery} class="conditional-content">
                                <lightning-checkbox-group 
                                    label="Service Types"
                                    options={serviceTypeOptions}
                                    value={formData.inhouseServices}
                                    onchange={handleCheckboxChange}
                                    name="inhouseServices">
                                </lightning-checkbox-group>
                            </div>
                        </div>

                        <!-- Franchisee -->
                        <div class="business-structure-item">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label toggle-label">
                                    Franchisee
                                    <lightning-helptext content="Operating under a franchise agreement where you deliver services using another organization's business model and branding."></lightning-helptext>
                                </label>
                                <lightning-input 
                                    type="toggle"
                                    name="franchisee"
                                    checked={formData.franchisee}
                                    onchange={handleToggleChange}>
                                </lightning-input>
                            </div>
                            <div if:true={formData.franchisee} class="conditional-content">
                                <lightning-checkbox-group 
                                    label="Service Types"
                                    options={serviceTypeOptions}
                                    value={formData.franchiseeServices}
                                    onchange={handleCheckboxChange}
                                    name="franchiseeServices">
                                </lightning-checkbox-group>
                            </div>
                        </div>

                        <!-- Franchisor -->
                        <div class="business-structure-item">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label toggle-label">
                                    Franchisor
                                    <lightning-helptext content="Licensing your business model and brand to other organizations who deliver services under your franchise system."></lightning-helptext>
                                </label>
                                <lightning-input 
                                    type="toggle"
                                    name="franchisor"
                                    checked={formData.franchisor}
                                    onchange={handleToggleChange}>
                                </lightning-input>
                            </div>
                            <div if:true={formData.franchisor} class="conditional-content">
                                <lightning-checkbox-group 
                                    label="Service Types"
                                    options={serviceTypeOptions}
                                    value={formData.franchisorServices}
                                    onchange={handleCheckboxChange}
                                    name="franchisorServices">
                                </lightning-checkbox-group>
                            </div>
                        </div>

                        <!-- Brokerage -->
                        <div class="business-structure-item">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label toggle-label">
                                    Brokerage
                                    <lightning-helptext content="Connecting clients with service providers while maintaining responsibility for service quality and coordination."></lightning-helptext>
                                </label>
                                <lightning-input 
                                    type="toggle"
                                    name="brokerage"
                                    checked={formData.brokerage}
                                    onchange={handleToggleChange}>
                                </lightning-input>
                            </div>
                            <div if:true={formData.brokerage} class="conditional-content">
                                <lightning-checkbox-group 
                                    label="Service Types"
                                    options={serviceTypeOptions}
                                    value={formData.brokerageServices}
                                    onchange={handleCheckboxChange}
                                    name="brokerageServices">
                                </lightning-checkbox-group>
                            </div>
                        </div>

                        <!-- Subcontractor -->
                        <div class="business-structure-item">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label toggle-label">
                                    Subcontractor
                                    <lightning-helptext content="Providing services under contract to another approved provider who maintains primary responsibility for client care."></lightning-helptext>
                                </label>
                                <lightning-input 
                                    type="toggle"
                                    name="subcontractor"
                                    checked={formData.subcontractor}
                                    onchange={handleToggleChange}>
                                </lightning-input>
                            </div>
                            <div if:true={formData.subcontractor} class="conditional-content">
                                <lightning-checkbox-group 
                                    label="Service Types"
                                    options={serviceTypeOptions}
                                    value={formData.subcontractorServices}
                                    onchange={handleCheckboxChange}
                                    name="subcontractorServices">
                                </lightning-checkbox-group>
                            </div>
                        </div>

                        <!-- Self-employed individual -->
                        <div class="business-structure-item">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label toggle-label">
                                    Self-employed individual
                                    <lightning-helptext content="Operating as a sole trader or individual practitioner providing direct care services."></lightning-helptext>
                                </label>
                                <lightning-input 
                                    type="toggle"
                                    name="selfEmployed"
                                    checked={formData.selfEmployed}
                                    onchange={handleToggleChange}>
                                </lightning-input>
                            </div>
                            <div if:true={formData.selfEmployed} class="conditional-content">
                                <lightning-checkbox-group 
                                    label="Service Types"
                                    options={serviceTypeOptions}
                                    value={formData.selfEmployedServices}
                                    onchange={handleCheckboxChange}
                                    name="selfEmployedServices">
                                </lightning-checkbox-group>
                            </div>
                        </div>

                        <!-- Other -->
                        <div class="business-structure-item">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label toggle-label">
                                    Other
                                    <lightning-helptext content="Any other business structure not covered by the above categories. Please provide details in the additional information section."></lightning-helptext>
                                </label>
                                <lightning-input 
                                    type="toggle"
                                    name="other"
                                    checked={formData.other}
                                    onchange={handleToggleChange}>
                                </lightning-input>
                            </div>
                            <div if:true={formData.other} class="conditional-content">
                                <lightning-checkbox-group 
                                    label="Service Types"
                                    options={serviceTypeOptions}
                                    value={formData.otherServices}
                                    onchange={handleCheckboxChange}
                                    name="otherServices">
                                </lightning-checkbox-group>
                                <lightning-textarea 
                                    label="Please describe your other business structure"
                                    value={formData.otherDescription}
                                    name="otherDescription"
                                    onchange={handleInputChange}
                                    placeholder="Provide details about your business structure">
                                    <lightning-helptext slot="help" content="Describe how your organization operates if it doesn't fit the standard categories above."></lightning-helptext>
                                </lightning-textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Workforce Configuration -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title">Workforce Configuration</h3>
                        <div class="slds-form-element">
                            <lightning-combobox 
                                label="How are your direct care workers primarily engaged?"
                                value={formData.workforceType}
                                placeholder="Select workforce engagement type"
                                options={workforceOptions}
                                onchange={handleInputChange}
                                name="workforceType"
                                required="true">
                                <lightning-helptext slot="help" content="Select the primary method by which your organization engages direct care workers."></lightning-helptext>
                            </lightning-combobox>
                        </div>
                    </div>

                    <!-- QA Assessor Comments -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title">QA Assessor Comments</h3>
                        <div class="qa-comments-readonly">
                            <lightning-formatted-text value={qaComments}></lightning-formatted-text>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Labour Costs Data Management -->
        <div if:true={isPage4} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">Labour Costs Data Management</h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Information Section -->
                    <lightning-accordion 
                        active-section-name={openSections} 
                        allow-multiple-sections-open="true"
                        onselect={handleAccordionToggle}>
                        <lightning-accordion-section name="labourCosts" label="About labour costs data">
                            <div class="slds-p-horizontal_medium">
                                <p>This section captures detailed breakdown of internal direct care labour costs to assess provider workforce composition and cost structures for regulatory oversight and benchmarking. Please enter costs as whole numbers without decimals.</p>
                            </div>
                        </lightning-accordion-section>
                    </lightning-accordion>

                    <!-- Table Controls -->
                    <div class="table-controls slds-m-top_large">
                        <div class="slds-grid slds-gutters">
                            <div class="slds-col">
                                <lightning-combobox 
                                    label="View All"
                                    value={tableFilter}
                                    placeholder="All Rows"
                                    options={filterOptions}
                                    onchange={handleFilterChange}
                                    name="tableFilter">
                                    <lightning-helptext slot="help" content="Filter the table to show specific types of data rows."></lightning-helptext>
                                </lightning-combobox>
                            </div>
                            <div class="slds-col">
                                <lightning-combobox 
                                    label="Jump to Section"
                                    value={jumpToSection}
                                    placeholder="Select section"
                                    options={sectionOptions}
                                    onchange={handleJumpToSection}
                                    name="jumpToSection">
                                    <lightning-helptext slot="help" content="Quickly navigate to a specific data category in the table."></lightning-helptext>
                                </lightning-combobox>
                            </div>
                            <div class="slds-col">
                                <lightning-combobox 
                                    label="Jump to Column"
                                    value={jumpToColumn}
                                    placeholder="Select column"
                                    options={columnOptions}
                                    onchange={handleJumpToColumn}
                                    name="jumpToColumn">
                                    <lightning-helptext slot="help" content="Focus on a specific column for data entry or review."></lightning-helptext>
                                </lightning-combobox>
                            </div>
                        </div>
                    </div>

                    <!-- Centrally Held Toggle -->
                    <div class="slds-form-element slds-m-top_medium">
                        <label class="slds-form-element__label toggle-label">
                            Centrally Held
                            <lightning-helptext content="Toggle this option if certain labour costs are managed centrally across multiple locations or divisions."></lightning-helptext>
                        </label>
                        <lightning-input 
                            type="toggle"
                            name="centrallyHeld"
                            checked={formData.centrallyHeld}
                            onchange={handleToggleChange}>
                        </lightning-input>
                    </div>

                    <!-- Labour Costs Data Table -->
                    <div class="labour-costs-table slds-m-top_medium">
                        <lightning-datatable
                            key-field="id"
                            data={labourCostsData}
                            columns={labourCostsColumns}
                            oncellchange={handleCellChange}
                            draft-values={draftValues}
                            hide-checkbox-column="true">
                        </lightning-datatable>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 5: Document Management and Submission -->
        <div if:true={isPage5} class="page-content">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">Document Management and Submission</h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Information Section -->
                    <lightning-accordion 
                        active-section-name={openSections} 
                        allow-multiple-sections-open="true"
                        onselect={handleAccordionToggle}>
                        <lightning-accordion-section name="documentManagement" label="About document requirements">
                            <div class="slds-p-horizontal_medium">
                                <p>Upload required supporting documentation to complete your QFR submission. Ensure all documents are properly categorized and in supported formats (PDF, Word, Excel, or image files).</p>
                            </div>
                        </lightning-accordion-section>
                    </lightning-accordion>

                    <!-- Document Upload Configuration -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title">Document Upload Configuration</h3>
                        <div class="slds-grid slds-gutters">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-combobox 
                                    label="Document Category"
                                    value={selectedCategory}
                                    placeholder="Select category"
                                    options={documentCategories}
                                    onchange={handleCategoryChange}
                                    name="selectedCategory"
                                    required="true">
                                    <lightning-helptext slot="help" content="Classify the purpose and type of document you are uploading."></lightning-helptext>
                                </lightning-combobox>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-combobox 
                                    label="Document Type"
                                    value={selectedDocumentType}
                                    placeholder="Select type"
                                    options={documentTypes}
                                    onchange={handleDocumentTypeChange}
                                    name="selectedDocumentType"
                                    required="true">
                                    <lightning-helptext slot="help" content="Specify the format and content type of your document."></lightning-helptext>
                                </lightning-combobox>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Interface -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title">File Upload</h3>
                        <div class="file-upload-area">
                            <lightning-file-upload
                                label="Upload Files"
                                name="fileUploader"
                                accept={acceptedFormats}
                                record-id={recordId}
                                onuploadfinished={handleUploadFinished}
                                multiple="true">
                                <lightning-helptext slot="help" content="Drag and drop files here or click to browse. Supported formats: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG."></lightning-helptext>
                            </lightning-file-upload>
                        </div>
                    </div>

                    <!-- Document Management Table -->
                    <div class="slds-section slds-m-top_large">
                        <h3 class="slds-section__title">Uploaded Documents</h3>
                        <lightning-datatable
                            key-field="id"
                            data={uploadedDocuments}
                            columns={documentColumns}
                            onrowaction={handleDocumentAction}
                            hide-checkbox-column="true">
                        </lightning-datatable>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
            <lightning-button 
                label="Previous"
                variant="neutral"
                onclick={handlePrevious}
                disabled={isPreviousDisabled}
                class="slds-m-right_medium">
            </lightning-button>
            
            <lightning-button 
                label={nextButtonLabel}
                variant="brand"
                onclick={handleNext}
                disabled={isNextDisabled}>
            </lightning-button>
        </div>

        <!-- Loading Spinner -->
        <div if:true={isLoading} class="slds-spinner_container">
            <lightning-spinner alternative-text="Processing..." size="medium"></lightning-spinner>
        </div>
    </div>
</template>
